<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operator Uplift - Gamified Goal Setting</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path d='M25.0558 23.4284L16 28.5713L6.94421 23.4284V13.1427L16 8L25.0558 13.1427V23.4284Z' stroke='%23f97316' stroke-width='2'/><path d='M16 18.2857L16 8M16 18.2857L22.9282 22.1429M16 18.2857L9.0718 22.1429' stroke='%23f97316' stroke-width='1.5'/></svg>" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- GLOBAL STYLES & CSS VARIABLES --- */
        :root {
            --accent-color: #f97316;
            --accent-color-light: #fb923c;
            --accent-color-glow: rgba(249, 115, 22, 0.6);
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --energy-color: #84cc16;
            --font-family: 'Inter', sans-serif;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --transition-fast: all 0.2s ease-in-out;
            --transition-slow: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        [data-theme="dark"] {
            --bg-color: #0a0a0a;
            --bg-gradient-start: #111827;
            --bg-gradient-end: #0a0a0a;
            --text-color: #e5e7eb;
            --text-muted-color: #9ca3af;
            --card-bg-glass: rgba(24, 24, 27, 0.4);
            --border-glass: rgba(255, 255, 255, 0.1);
            --sidebar-bg: rgba(10, 10, 10, 0.8);
            --input-bg: rgba(0,0,0,0.2);
            --particle-color: #ffffff;
            --matrix-rain-color: rgba(249, 115, 22, 0.35);
        }
        
        [data-theme="light"] {
            --bg-color: #f9fafb;
            --bg-gradient-start: #f8fbff;
            --bg-gradient-end: #fafcff;
            --text-color: #1f2937;
            --text-muted-color: #4b5563;
            --card-bg-glass: rgba(255, 255, 255, 0.4);
            --border-glass: rgba(0, 0, 0, 0.1);
            --sidebar-bg: rgba(230, 230, 230, 0.8);
            --input-bg: rgba(255,255,255,0.5);
            --particle-color: #1f2937;
            --matrix-rain-color: rgba(249, 115, 22, 0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-color);
            transition: background 1s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        #matrix-rain-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; opacity: 0.5; }
        .app-wrapper { position: relative; z-index: 10; }
        .hidden { display: none !important; }

        /* --- BUTTONS & CARDS --- */
        .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: 600;
            cursor: pointer; transition: var(--transition-fast); display: inline-flex;
            align-items: center; justify-content: center; gap: 0.5rem; text-decoration: none;
        }
        .btn:disabled { cursor: not-allowed; background-color: #52525b; opacity: 0.7; }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }
        .btn-icon { padding: 0.5rem; }
        .btn-primary { background-color: var(--accent-color); color: black; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-color-light); box-shadow: 0 0 20px var(--accent-color-glow); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-outline { background-color: transparent; border: 1px solid var(--border-glass); color: var(--text-color); }
        .btn-outline:hover { background-color: rgba(255,255,255,0.1); }
        [data-theme="light"] .btn-outline:hover { background-color: rgba(0,0,0,0.05); }
        .card {
            background: var(--card-bg-glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-glass); border-radius: 0.75rem;
            padding: 1.5rem; box-shadow: var(--shadow); transition: var(--transition-slow);
            position: relative; overflow: hidden;
        }
        .card:hover { border-color: var(--accent-color); }
        .card::after { /* Holographic glare effect */
            content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%;
            transform: skewX(-25deg);
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0) 100%);
            transition: left 0.8s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .card:hover::after { left: 150%; }

        /* --- STRUCTURE --- */
        #app-container { display: flex; min-height: 100vh; }
        #sidebar {
            width: 250px; background-color: var(--sidebar-bg); backdrop-filter: blur(15px);
            border-right: 1px solid var(--border-glass); padding: 1.5rem 1rem;
            display: flex; flex-direction: column; transition: var(--transition-slow); z-index: 20;
        }
        #main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; }
        #app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        
        /* --- MODAL STYLES --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--card-bg-glass); border: 1px solid var(--border-glass);
            padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px;
            position: relative; transform: scale(0.95); transition: transform 0.3s;
        }
        .modal.active .modal-content { transform: scale(1); }
        .modal-close {
            position: absolute; top: 1rem; right: 1rem; background: none; border: none;
            font-size: 1.5rem; cursor: pointer; color: var(--text-muted-color);
        }
        
        /* --- FORM & TOGGLE STYLES --- */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-muted-color); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-glass);
            background-color: var(--input-bg); color: var(--text-color); transition: var(--transition-fast);
        }
        .form-group select option {
            background: var(--bg-color);
            color: var(--text-color);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-color-glow);
        }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3f3f46; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(18px); }
        
        /* --- SIDEBAR & NAVIGATION --- */
        .logo { display: flex; align-items: center; gap: 0.5rem; font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: var(--text-color); }
        .nav-menu { list-style: none; }
        .nav-item a {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem;
            color: var(--text-muted-color); text-decoration: none; font-weight: 500; transition: var(--transition-fast);
        }
        .nav-item a:hover { background-color: var(--card-bg-glass); color: var(--text-color); }
        .nav-item a.active { background-color: var(--accent-color); color: var(--bg-color); }
        [data-theme="light"] .nav-item a.active { color: white; }
        .sidebar-footer { margin-top: auto; }
        
        /* --- GOAL & TASK LIST (REVAMPED) --- */
        .goal-list, .task-list, .subgoal-list { list-style: none; padding-left: 0; }
        .goal-item {
            padding: 1rem; border-bottom: 1px solid var(--border-glass);
            transition: var(--transition-fast);
        }
        .goal-item:hover { background-color: rgba(255,255,255,0.05); }
        [data-theme="light"] .goal-item:hover { background-color: rgba(0,0,0,0.05); }
        .goal-header { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .goal-header .toggle-icon { transition: transform 0.2s; }
        .goal-content.collapsed .toggle-icon { transform: rotate(-90deg); }
        .goal-title { flex-grow: 1; font-weight: 600; }
        .goal-content {
            max-height: 2000px; overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding-top 0.5s ease-in-out;
            padding-top: 1rem;
        }
        .goal-content.collapsed { max-height: 0; padding-top: 0; }
        .subgoal-list { margin-left: 1.5rem; border-left: 2px solid var(--border-glass); }
        .task-list { margin-top: 0.5rem; }
        .task-item { display: flex; align-items: flex-start; gap: 1rem; padding: 0.5rem; border-radius: 0.25rem; transition: background-color 0.2s; }
        .task-item-main { display: flex; align-items: center; width: 100%; gap: 1rem;}
        .task-item.completed-animation { animation: complete-task-anim 0.5s ease-out; }
        @keyframes complete-task-anim { 0% { background-color: var(--accent-color-glow); } 100% { background-color: transparent; } }
        .task-checkbox { margin-top: 4px; flex-shrink: 0; width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent-color); }
        .task-description { flex-grow: 1; cursor: pointer; }
        .task-description.completed { text-decoration: line-through; color: var(--text-muted-color); }
        .task-due-date { font-size: 0.8rem; color: var(--text-muted-color); }
        .task-due-date.overdue { color: var(--danger-color); font-weight: 600; }
        .task-item.dragging { opacity: 0.5; background: var(--accent-color-glow); }
        .task-edit-input {
            width: 100%; background: transparent; border: none;
            border-bottom: 1px solid var(--accent-color); color: var(--text-color);
            padding: 0.25rem; font-family: inherit; font-size: inherit;
        }
        .task-edit-input:focus { outline: none; }
        .goal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; border-top: 1px solid var(--border-glass); padding-top: 1rem; flex-wrap: wrap; }
        .subtask-list { list-style: none; padding-left: 2.5rem; margin-top: 0.5rem; }
        .subtask-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-muted-color); }
        .subtask-item.completed { text-decoration: line-through; }
        .progress-status { font-size: 0.8rem; color: var(--secondary-color); margin-left: auto; }
        .progress-bar-small { height: 4px; background-color: rgba(0,0,0,0.3); border-radius: 2px; margin-top: 0.25rem; }
        .progress-bar-fill-small { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--secondary-color), var(--accent-color)); }
        
        /* --- GAMIFICATION & DASHBOARD --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; }
        .stat-card { text-align: center; }
        .stat-card .value { font-size: 2.5rem; font-weight: 700; text-shadow: 0 0 8px var(--accent-color-glow); }
        .stat-card .value.energy { color: var(--energy-color); text-shadow: 0 0 8px var(--energy-color); }
        .stat-card .value.essence { color: var(--accent-color); }
        .stat-card .label { font-weight: 500; color: var(--text-muted-color); display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .progress-bar { width: 100%; height: 20px; background-color: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; margin-top: 0.75rem; }
        [data-theme="light"] .progress-bar { background-color: rgba(0,0,0,0.1); }
        .progress-bar-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease-in-out; }
        .progress-bar-fill.xp { background: linear-gradient(90deg, var(--accent-color-light), var(--accent-color)); }
        .progress-bar-fill.energy { background: linear-gradient(90deg, #a3e635, var(--energy-color)); }
        .progress-bar-fill.challenge { background: linear-gradient(90deg, var(--info-color), var(--secondary-color)); }

        .achievement-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.5rem; }
        .achievement-badge { text-align: center; filter: grayscale(1); opacity: 0.6; transition: var(--transition-slow); position: relative; }
        .achievement-badge.unlocked { filter: grayscale(0); opacity: 1; transform: scale(1.05); }
        .achievement-badge.celebrate { animation: celebrate 1s ease-out; }
        @keyframes celebrate { 0% { transform: scale(1); } 50% { transform: scale(1.2) rotate(10deg); } 100% { transform: scale(1); } }
        .badge-icon { font-size: 3rem; }
        .badge-tier {
            position: absolute; top: 0; right: 0; font-size: 0.7rem; font-weight: bold; padding: 2px 5px;
            border-radius: 4px; color: white;
        }
        .badge-tier.Bronze { background-color: #cd7f32; }
        .badge-tier.Silver { background-color: #c0c0c0; }
        .badge-tier.Gold { background-color: #ffd700; color: #333; }
        .badge-tier.Platinum { background: linear-gradient(135deg, #e5e4e2, #b2beb5); color: #333; text-shadow: 0 0 2px white; }
        .badge-tier.Legendary { background: linear-gradient(135deg, #6a0dad, #c400c4); color: white; text-shadow: 0 0 5px #ff00ff; }

        .chart-container { height: 200px; }

        /* --- NEW DASHBOARD WIDGETS --- */
        #ai-mentor-widget .mentor-message {
            font-style: italic; color: var(--text-muted-color);
            border-left: 3px solid var(--accent-color);
            padding-left: 1rem; margin-bottom: 1rem;
        }
        #character-stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
        }
        .stat-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; padding: 0.25rem 0;}

        /* --- JOURNEYS VIEW --- */
        .journey-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .journey-card { text-align: center; }
        .journey-card .journey-icon { font-size: 3rem; margin-bottom: 1rem; }
        .journey-card .btn { width: 100%; margin-top: 1rem; }
        .journey-status { font-weight: bold; padding: 0.25rem 0.5rem; border-radius: 0.5rem; display: inline-block; margin-top: 0.5rem; }
        .journey-status.in-progress { background-color: var(--accent-color); color: white; }
        .journey-status.completed { background-color: var(--secondary-color); color: white; }
        
        /* --- CALENDAR VIEW --- */
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        #calendar-header h2 { font-size: 1.5rem; font-weight: 600; }
        #calendar-header button { background: none; border: 1px solid var(--border-glass); border-radius: 50%; width: 36px; height: 36px; cursor: pointer; transition: var(--transition-fast); }
        #calendar-header button:hover { background-color: var(--card-bg-glass); }
        #calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; color: var(--text-muted-color); margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-glass); }
        #calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day {
            min-height: 120px; border: 1px solid var(--border-glass); border-radius: 0.5rem;
            padding: 0.5rem; transition: var(--transition-fast); cursor: pointer;
        }
        .calendar-day:hover { background-color: var(--card-bg-glass); border-color: var(--accent-color-light); }
        .calendar-day.other-month { opacity: 0.4; }
        .calendar-day.today .day-number {
            background-color: var(--accent-color); color: white;
            border-radius: 50%; display: inline-block; width: 24px; height: 24px;
            line-height: 24px; text-align: center;
        }
        .calendar-day.drag-over { border: 2px dashed var(--accent-color); }
        .day-number { font-weight: 600; }
        .calendar-tasks { margin-top: 0.5rem; display: flex; flex-direction: column; gap: 4px; }
        .calendar-task {
            padding: 4px 6px; border-radius: 4px; font-size: 0.8rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: grab; transition: var(--transition-fast);
        }
        .calendar-task.dragging { opacity: 0.5; }
        .calendar-task.overdue { background-color: var(--danger-color); color: white; }
        .calendar-task.today { background-color: var(--accent-color); color: black; }
        .calendar-task.upcoming { background-color: var(--secondary-color); color: white; }
        .calendar-task.completed { text-decoration: line-through; opacity: 0.7; background-color: #52525b; }

        /* --- COMMUNITY VIEW --- */
        .community-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; }
        #leaderboard-list, #friend-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .leaderboard-item, .friend-item { display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-glass); }
        .leaderboard-item:last-child, .friend-item:last-child { border-bottom: none; }
        .leaderboard-item.current-user { background-color: var(--accent-color-glow); border-radius: 0.5rem;}
        .leaderboard-rank { font-weight: 700; font-size: 1.2rem; width: 40px; text-align: center; color: var(--text-muted-color); }
        .leaderboard-name, .friend-name { flex-grow: 1; font-weight: 500; }
        .leaderboard-points, .friend-points { font-weight: 700; color: var(--accent-color); }
        #template-tabs { display: flex; border-bottom: 1px solid var(--border-glass); margin-bottom: 1rem; }
        .template-tab { padding: 0.5rem 1rem; cursor: pointer; font-weight: 500; color: var(--text-muted-color); border-bottom: 2px solid transparent; }
        .template-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        #challenge-list { display: flex; flex-direction: column; gap: 1.5rem; }
        .challenge-card { padding: 1rem; }
        
        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar {
                width: 100%; height: auto; flex-direction: row; justify-content: space-between; align-items: center;
                padding: 1rem; border-right: none; border-bottom: 1px solid var(--border-glass);
            }
            .logo { margin-bottom: 0; } .nav-menu { display: flex; gap: 0.5rem; }
            .nav-item a { padding: 0.5rem; } .nav-item a .nav-text { display: none; }
            .sidebar-footer { display: none; } #main-content { padding: 1rem; }
            #app-header { margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
            .calendar-day { min-height: 80px; font-size: 0.8rem; }
            .calendar-task { font-size: 0.7rem; }
        }

        /* --- TOAST & LOADING --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1001; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            padding: 15px 20px; border-radius: 8px; color: white; font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0;
            transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
        }
        .toast.success { background-color: var(--secondary-color); } .toast.error { background-color: var(--danger-color); } .toast.info { background-color: var(--info-color); }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.5s;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--border-glass);
            border-radius: 50%; animation: spin 1s linear infinite, color-pulse 2s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes color-pulse {
            0% { border-top-color: var(--accent-color); }
            50% { border-top-color: var(--secondary-color); }
            100% { border-top-color: var(--accent-color); }
        }
        #loading-overlay p { margin-top: 1rem; font-weight: 500; animation: fadeIn 1s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- AUTH VIEW --- */
        #auth-view-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; }
        #auth-view .card { width: 100%; max-width: 400px; }
        .auth-header { text-align: center; margin-bottom: 1.5rem; }
        .auth-header h2 { font-size: 1.75rem; }
        .auth-header p { color: var(--text-muted-color); }

        /* --- Celebration Canvas --- */
        #celebration-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden;
        }
        .firework {
            position: absolute;
            width: 4px; height: 4px;
            background-color: var(--accent-color);
            border-radius: 50%;
            opacity: 0;
            animation: firework-animation 1.5s ease-out forwards;
        }
        @keyframes firework-animation {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: translateY(-200px) scale(0); opacity: 0; }
        }
        
        /* Treasure Chest */
        #treasure-chest-widget { text-align: center; }
        #treasure-chest-widget .chest-icon { font-size: 3rem; cursor: pointer; transition: transform 0.2s; }
        #treasure-chest-widget .chest-icon:hover { transform: scale(1.1); }
        #treasure-chest-widget .chest-icon.ready { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .chest-reward { text-align: center; animation: reveal 0.5s ease-out; }
        @keyframes reveal { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Color Schemes */
        .color-scheme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .color-swatch {
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid transparent;
            text-align: center;
            transition: var(--transition-fast);
            font-size: 0.875rem;
            font-weight: 500;
        }
        .color-swatch:hover {
            background-color: var(--input-bg);
        }
        .color-swatch.active {
            border-color: var(--accent-color);
            background-color: var(--input-bg);
        }
        .color-swatch-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
            border: 1px solid var(--border-glass);
        }
        
        /* SVG Styling */
        .logo svg { color: var(--accent-color); }

        /* Mood Modal */
        #mood-selector { display: flex; justify-content: space-around; margin: 2rem 0; }
        .mood-btn { background: none; border: none; font-size: 3rem; cursor: pointer; transition: transform 0.2s; }
        .mood-btn:hover { transform: scale(1.2); }
        
        /* --- ONBOARDING MODALS --- */
        .tutorial-step { margin-bottom: 1rem; }
        .tutorial-step h4 { margin-bottom: 0.5rem; }
        .tutorial-step p { color: var(--text-muted-color); }
        #tutorial-modal .modal-content, #profile-analysis-modal .modal-content { max-width: 600px; }
        #profile-analysis-results { margin-top: 1rem; white-space: pre-wrap; color: var(--text-muted-color); }

    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner"></div><p>Initializing Operator Uplift...</p></div>
    <div id="tsparticles"></div>
    <canvas id="matrix-rain-canvas"></canvas>
    <div id="celebration-container"></div>
    <div class="app-wrapper">
        <div id="app-container">
            <!-- Sidebar -->
            <aside id="sidebar" class="hidden">
                <div>
                    <div class="logo">
                         <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><use href="#logo-path"/></svg>
                         <span>Operator Uplift</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-item"><a href="#" data-view="dashboard" class="active"><span>üìä</span><span class="nav-text">Dashboard</span></a></li>
                        <li class="nav-item"><a href="#" data-view="goals"><span>üèÜ</span><span class="nav-text">Goals</span></a></li>
                        <li class="nav-item"><a href="#" data-view="journeys"><span>üó∫Ô∏è</span><span class="nav-text">Journeys</span></a></li>
                        <li class="nav-item"><a href="#" data-view="calendar"><span>üìÖ</span><span class="nav-text">Calendar</span></a></li>
                        <li class="nav-item"><a href="#" data-view="community"><span>üåê</span><span class="nav-text">Community</span></a></li>
                        <li class="nav-item"><a href="#" data-view="achievements"><span>üèÖ</span><span class="nav-text">Achievements</span></a></li>
                        <li class="nav-item"><a href="#" data-view="settings"><span>‚öôÔ∏è</span><span class="nav-text">Settings</span></a></li>
                    </ul>
                </div>
                <div class="sidebar-footer">
                    <div id="user-profile-widget" class="card">
                        <h4 id="profile-name"></h4>
                        <p id="profile-email" style="font-size: 0.8rem; color: var(--text-muted-color);"></p>
                        <button id="logout-btn" class="btn btn-danger" style="width: 100%; margin-top: 1rem;">Logout</button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main id="main-content">
                <header id="app-header" class="hidden">
                    <h1 id="view-title" style="font-size: 2.5rem; font-weight: 700;">Dashboard</h1>
                    <div style="display: flex; gap: 1rem;">
                        <button id="add-goal-template-btn" class="btn btn-outline">Create from Template</button>
                        <button id="add-goal-btn" class="btn btn-primary"><span>+</span> New Goal</button>
                    </div>
                </header>
                <div id="view-container">
                    <!-- Auth View -->
                    <div id="auth-view">
                        <div id="auth-view-wrapper">
                            <div class="card">
                                <div class="auth-header">
                                    <h2>Welcome to Operator Uplift</h2>
                                    <p>Deconstruct Your Ambition. Engineer Your Ascent.</p>
                                </div>
                                <div id="login-form">
                                    <form id="login-form-element">
                                        <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                                        <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                                        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                                    </form>
                                    <p style="text-align: center; margin-top: 1rem;">No account? <a href="#" id="show-register" style="color: var(--accent-color);">Register here</a></p>
                                </div>
                                <div id="register-form" class="hidden">
                                    <form id="register-form-element">
                                        <div class="form-group"><label for="register-name">Display Name</label><input type="text" id="register-name" required></div>
                                        <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                                        <div class="form-group"><label for="register-password">Password (min. 6 characters)</label><input type="password" id="register-password" minlength="6" required></div>
                                        <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
                                    </form>
                                    <p style="text-align: center; margin-top: 1rem;">Already have an account? <a href="#" id="show-login" style="color: var(--accent-color);">Login here</a></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard View -->
                    <div id="dashboard-view" class="view hidden">
                        <div class="card" id="ai-mentor-widget" style="margin-bottom: 2rem;">
                            <h3>Your AI Mentor</h3>
                            <p class="mentor-message">Loading message...</p>
                        </div>

                        <div class="stats-grid">
                            <div class="card stat-card"><div id="dashboard-points" class="value essence">0</div><div class="label"><span>üí∞</span>Essence</div></div>
                            <div class="card stat-card"><div id="dashboard-energy" class="value energy">100</div><div class="label"><span>‚ö°</span>Energy</div></div>
                            <div class="card stat-card"><div id="dashboard-level" class="value">1</div><div class="label"><span>‚≠ê</span>Chapter</div></div>
                            <div class="card stat-card"><div id="dashboard-streak" class="value">üî• 0</div><div class="label"><span>üî•</span>Daily Streak</div></div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem;">
                            <div class="card">
                                <h3>Chapter Progress</h3>
                                <p id="level-progress-text">0/100 XP</p>
                                <div class="progress-bar"><div id="level-progress-bar" class="progress-bar-fill xp" style="width: 0%;"></div></div>
                            </div>
                             <div class="card">
                                <h3>Energy Level</h3>
                                <p id="energy-level-text">100 / 100</p>
                                <div class="progress-bar"><div id="energy-progress-bar" class="progress-bar-fill energy" style="width: 100%;"></div></div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem;">
                            <div class="card">
                                <h3>Weekly Activity</h3>
                                <div id="weekly-chart" class="chart-container"></div>
                            </div>
                             <div id="character-stats-widget" class="card">
                                <h3>Operator Profile</h3>
                                <div id="character-stats-grid"></div>
                            </div>
                        </div>
                         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem;">
                            <div id="treasure-chest-widget" class="card">
                                <h3>Treasure Chest</h3>
                                <div id="chest-icon" class="chest-icon">üéÅ</div>
                                <p id="chest-progress-text">Complete tasks to unlock</p>
                            </div>
                             <div class="card">
                                <h3>Share Your Progress</h3>
                                <p style="color: var(--text-muted-color); margin-bottom: 1rem;">Copy a summary of your stats or share directly to X.</p>
                                 <div style="display: flex; gap: 1rem;">
                                    <button id="share-progress-btn" class="btn btn-secondary" style="flex: 1;"><span>üîó</span> Copy Summary</button>
                                    <button id="share-x-btn" class="btn btn-secondary" style="flex: 1; background-color: #1DA1F2;"><span>üïäÔ∏è</span> Share on X</button>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Goals View -->
                    <div id="goals-view" class="view hidden"><div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 id="goals-view-title">Active Quests</h3>
                            <div style="display: flex; gap: 0.5rem; border: 1px solid var(--border-glass); border-radius: 0.5rem; padding: 0.25rem;">
                                <button id="show-active-goals-btn" class="btn btn-sm active">Active</button>
                                <button id="show-archived-goals-btn" class="btn btn-sm">Archived</button>
                            </div>
                        </div>
                        <ul id="goal-list" class="goal-list"></ul>
                        <p id="no-goals-message" class="hidden">No quests here. Create one to begin your saga!</p>
                    </div></div>

                    <!-- Journeys View -->
                    <div id="journeys-view" class="view hidden">
                        <div class="card">
                            <h3>Mastery Journeys</h3>
                            <p style="color: var(--text-muted-color); margin-bottom: 1.5rem;">Embark on long-term paths to build powerful habits and skills. Each journey creates a detailed quest in your Goals tab.</p>
                            <div id="journey-grid" class="journey-grid"></div>
                        </div>
                    </div>
                    
                    <!-- Calendar View -->
                    <div id="calendar-view" class="view hidden">
                        <div class="card">
                            <div id="calendar-header">
                                <button id="prev-month-btn" aria-label="Previous Month">&lt;</button>
                                <h2 id="month-year-header"></h2>
                                <button id="next-month-btn" aria-label="Next Month">&gt;</button>
                            </div>
                            <div id="calendar-weekdays">
                                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                            </div>
                            <div id="calendar-days"></div>
                        </div>
                    </div>

                    <!-- Community View -->
                    <div id="community-view" class="view hidden">
                        <div class="community-grid">
                            <div class="card">
                                <h3>Leaderboard</h3>
                                <p style="color: var(--text-muted-color); margin-bottom: 1rem;">See how you rank among all Operators based on total Essence.</p>
                                <ul id="leaderboard-list"></ul>
                            </div>
                             <div class="card">
                                <h3>Community Challenges</h3>
                                <p style="color: var(--text-muted-color); margin-bottom: 1rem;">Join global challenges to earn exclusive rewards. Progress is shared across all Operators.</p>
                                <div id="challenge-list"></div>
                            </div>
                            <div class="card">
                                <h3>Friends</h3>
                                <p style="color: var(--text-muted-color); margin-bottom: 1rem;">Add friends by sharing your User ID or entering theirs.</p>
                                <form id="add-friend-form" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                    <input type="text" id="add-friend-uid" placeholder="Friend's User ID" class="form-group" style="flex-grow: 1; margin-bottom: 0;" required>
                                    <button type="submit" class="btn btn-primary">Add</button>
                                </form>
                                <ul id="friend-list"></ul>
                                <p style="color: var(--text-muted-color); font-size: 0.9rem; margin-top: 1rem;">Your User ID: <strong id="user-id-display"></strong> <button id="copy-uid-btn" class="btn btn-sm btn-outline">Copy</button></p>
                            </div>
                        </div>
                    </div>

                    <!-- Achievements View -->
                    <div id="achievements-view" class="view hidden"><div class="card"><div id="achievement-gallery" class="achievement-gallery"></div></div></div>
                    
                    <!-- Settings View -->
                    <div id="settings-view" class="view hidden"><div class="card">
                        <h3>Settings</h3>
                        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid var(--border-glass);">
                            <label for="theme-toggle">Theme</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>Light</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="theme-toggle">
                                    <span class="slider"></span>
                                </label>
                                <span>Dark</span>
                            </div>
                        </div>
                        <div style="padding: 1rem 0; border-bottom: 1px solid var(--border-glass);">
                            <h3>Color Scheme</h3>
                            <div id="color-scheme-grid" class="color-scheme-grid"></div>
                        </div>
                        <div class="form-group" style="padding: 1rem 0; border-bottom: 1px solid var(--border-glass);">
                            <label for="motivational-style-select">AI Mentor Personality</label>
                            <select id="motivational-style-select">
                                <option value="Mentor">The Wise Mentor</option>
                                <option value="Competitor">The Fierce Competitor</option>
                                <option value="Achiever">The Driven Achiever</option>
                                <option value="Explorer">The Curious Explorer</option>
                            </select>
                        </div>
                         <div class="form-group" style="padding: 1rem 0; border-bottom: 1px solid var(--border-glass);">
                            <h3>AI Configuration</h3>
                             <div class="form-group">
                                <label for="ai-provider-select">AI Provider</label>
                                 <p style="color: var(--text-muted-color); font-size: 0.9rem; margin-bottom: 0.75rem;">Select an AI to power task generation and mentor advice. This is now handled securely on the server.</p>
                                <select id="ai-provider-select">
                                    <option value="none">None (Default Tasks)</option>
                                    <option value="gemini">Gemini</option>
                                    <option value="xai">xAI (Grok)</option>
                                    <option value="claude">Anthropic (Claude)</option>
                                    <option value="perplexity">Perplexity</option>
                                </select>
                             </div>
                         </div>
                        <h3 style="margin-top: 2rem;">Data Management</h3>
                        <p style="color: var(--text-muted-color); margin-bottom: 1rem;">Your data is now securely stored in the cloud.</p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                             <button id="delete-account-btn" class="btn btn-danger">Delete Account & Data</button>
                        </div>
                    </div></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="goal-modal" class="modal"><div class="modal-content">
        <button class="modal-close">&times;</button><h3 id="goal-modal-title">New Quest</h3>
        <form id="goal-form">
            <input type="hidden" id="goal-id-input">
            <input type="hidden" id="goal-parent-id-input">
            <div class="form-group"><label for="goal-title">Quest Title</label><input type="text" id="goal-title" required></div>
            <div class="form-group"><label for="goal-description">Description</label><textarea id="goal-description" rows="3"></textarea></div>
            <div class="form-group"><label for="goal-category">Skill Area</label><select id="goal-category"><option>Personal</option><option>Work</option><option>Health</option><option>Learning</option><option>Finance</option></select></div>
            <div class="form-group"><label for="goal-priority">Priority</label><select id="goal-priority"><option>Low</option><option>Medium</option><option>High</option></select></div>
            <div class="form-group"><label for="goal-due-date">Due Date</label><input type="date" id="goal-due-date"></div>
            <button type="submit" id="goal-form-submit-btn" class="btn btn-primary" style="width: 100%;">Embark on Quest</button>
        </form>
    </div></div>
    <div id="template-modal" class="modal"><div class="modal-content">
        <button class="modal-close">&times;</button><h3>Choose a Quest Template</h3>
        <div id="template-tabs">
            <div class="template-tab active" data-tab="system">System</div>
            <div class="template-tab" data-tab="community">Community</div>
        </div>
        <div id="template-list-container">
            <div id="template-list-system"></div>
            <div id="template-list-community" class="hidden"></div>
        </div>
    </div></div>
    <div id="confirm-modal" class="modal"><div class="modal-content">
        <h3 id="confirm-title">Are you sure?</h3>
        <p id="confirm-text" style="color: var(--text-muted-color); margin: 1rem 0;"></p>
        <div style="display: flex; justify-content: flex-end; gap: 1rem;">
            <button id="confirm-cancel-btn" class="btn btn-outline">Cancel</button>
            <button id="confirm-ok-btn" class="btn btn-danger">Confirm</button>
        </div>
    </div></div>
    <div id="lucky-wheel-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <button class="modal-close">&times;</button>
            <h3>Daily Lucky Wheel</h3>
            <p>Spin for a daily reward!</p>
            <div id="wheel-container" style="position: relative; width: 300px; height: 300px; margin: 1rem auto;">
                <canvas id="lucky-wheel-canvas" width="300" height="300"></canvas>
                <div id="wheel-pointer" style="position: absolute; left: 50%; top: -10px; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid var(--accent-color);"></div>
            </div>
            <button id="spin-wheel-btn" class="btn btn-primary">Spin!</button>
        </div>
    </div>
    <div id="treasure-chest-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
             <button class="modal-close">&times;</button>
            <h3>Treasure Chest Unlocked!</h3>
            <p>You completed enough tasks to earn a reward.</p>
            <div id="chest-reward-content" style="min-height: 100px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 1rem 0;">
                <div id="closed-chest-icon" style="font-size: 4rem; cursor: pointer;">üéÅ</div>
                <div id="opened-chest-reward" class="hidden"></div>
            </div>
        </div>
    </div>
    <div id="mood-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <button class="modal-close">&times;</button>
            <h3>How are you feeling today?</h3>
            <p>Your emotional state can influence your journey. Let's track it.</p>
            <div id="mood-selector">
                <button class="mood-btn" data-mood="motivated">üöÄ</button>
                <button class="mood-btn" data-mood="happy">üòä</button>
                <button class="mood-btn" data-mood="neutral">üòê</button>
                <button class="mood-btn" data-mood="sad">üòî</button>
                <button class="mood-btn" data-mood="stressed">üò†</button>
            </div>
        </div>
    </div>
    <div id="journey-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <button class="modal-close">&times;</button>
            <h3 id="journey-modal-title"></h3>
            <p id="journey-modal-description" style="color: var(--text-muted-color); margin: 1rem 0;"></p>
            <p>Starting this journey will add a new, detailed quest to your Goals tab.</p>
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button id="journey-confirm-start-btn" class="btn btn-primary">Begin Journey</button>
            </div>
        </div>
    </div>
    <div id="tutorial-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3>Welcome to Operator Uplift!</h3>
            <div id="tutorial-steps">
                <div class="tutorial-step">
                    <h4>Step 1: Set Your First Goal</h4>
                    <p>Click the "+ New Goal" button to create your first quest. You can also use a template to get started quickly!</p>
                </div>
                <div class="tutorial-step">
                    <h4>Step 2: Complete Tasks</h4>
                    <p>Check off tasks as you complete them to earn Essence and level up. Use the ‚ú® button to break down complex tasks with AI.</p>
                </div>
                <div class="tutorial-step">
                    <h4>Step 3: Explore Journeys</h4>
                    <p>Navigate to the Journeys view for long-term, pre-built challenges designed to help you build powerful habits.</p>
                </div>
                <div class="tutorial-step">
                    <h4>Step 4: Customize Settings</h4>
                    <p>Adjust the theme, color scheme, and select your preferred AI provider in the Settings menu to personalize your experience.</p>
                </div>
            </div>
            <button id="tutorial-close-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Let's Go!</button>
        </div>
    </div>
    <div id="profile-analysis-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3>New Operator Onboarding</h3>
            <p>To create a personalized experience, please answer these questions. Your AI mentor will use this to provide tailored advice.</p>
            <form id="profile-analysis-form">
                <div class="form-group"><label for="profile-age">Age</label><input type="number" id="profile-age" required></div>
                <div class="form-group"><label for="profile-occupation">Occupation</label><input type="text" id="profile-occupation" required></div>
                <div class="form-group"><label for="profile-goals">What are your top 3 goals right now?</label><textarea id="profile-goals" rows="3" required></textarea></div>
                <div class="form-group"><label for="profile-strengths">What are your key strengths?</label><textarea id="profile-strengths" rows="2" required></textarea></div>
                <div class="form-group"><label for="profile-weaknesses">What areas do you want to improve?</label><textarea id="profile-weaknesses" rows="2" required></textarea></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Analyze Profile</button>
            </form>
            <div id="profile-analysis-results" class="hidden"></div>
        </div>
    </div>
    <div id="add-task-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3>Add New Task</h3>
            <form id="add-task-form">
                <input type="hidden" id="add-task-goal-id">
                <div class="form-group"><label for="add-task-description-input">Task Description</label><input type="text" id="add-task-description-input" required></div>
                <div class="form-group"><label for="add-task-due-date-input">Due Date</label><input type="date" id="add-task-due-date-input"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Task</button>
            </form>
        </div>
    </div>
    <div id="calendar-add-task-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3>Quick Add Task</h3>
            <form id="calendar-add-task-form">
                <input type="hidden" id="calendar-task-due-date">
                <div class="form-group">
                    <label for="calendar-task-goal-select">Select Quest</label>
                    <select id="calendar-task-goal-select" required></select>
                </div>
                <div class="form-group">
                    <label for="calendar-task-description-input">Task Description</label>
                    <input type="text" id="calendar-task-description-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Task</button>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>
    
    <!-- SVG Definitions for reuse -->
    <svg width="0" height="0" style="position:absolute">
      <defs>
        <g id="logo-path">
          <path d="M25.0558 23.4284L16 28.5713L6.94421 23.4284V13.1427L16 8L25.0558 13.1427V23.4284Z" stroke="currentColor" stroke-width="2"/>
          <path d="M16 18.2857L16 8M16 18.2857L22.9282 22.1429M16 18.2857L9.0718 22.1429" stroke="currentColor" stroke-width="1.5"/>
        </g>
      </defs>
    </svg>

    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            addDoc,
            updateDoc,
            deleteDoc,
            query,
            where,
            getDocs,
            onSnapshot,
            writeBatch,
            serverTimestamp,
            arrayUnion,
            increment
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE VARIABLES ---
        let db, auth;
        let unsubscribeUser, unsubscribeGoals, unsubscribeCommunityTemplates, unsubscribeLeaderboard, unsubscribeChallenges, unsubscribeFriends;

        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // --- STATE MANAGEMENT ---
                state: {
                    firebaseReady: false,
                    currentUser: null, // This will hold the user object from Firebase Auth
                    userData: null, // This will hold the user data from Firestore
                    localGoals: {}, // Local cache for goals
                    communityTemplates: {}, // Local cache for community templates
                    leaderboardData: [], // Local cache for leaderboard
                    friendsData: [], // Local cache for friends' data
                    globalChallenges: {}, // Local cache for global challenges
                    activeView: 'auth', 
                    showingArchived: false,
                    particlesInstance: null, 
                    energyInterval: null, 
                    matrixInterval: null,
                    calendarDate: new Date(),
                    achievements: {
                        // Bronze Tier
                        first_goal: { name: "Quest Giver", icon: "üå±", description: "Embark on your first quest.", tier: "Bronze", points: 10 },
                        first_task: { name: "First Step", icon: "üëü", description: "Complete your first task.", tier: "Bronze", points: 5 },
                        hundred_points: { name: "Essence Collector", icon: "üí∞", description: "Earn 100 Essence.", tier: "Bronze", points: 10 },
                        five_tasks_one_day: { name: "Day Striker", icon: "üéØ", description: "Complete 5 tasks in a single day.", tier: "Bronze", points: 15 },
                        first_friend: { name: "Social Operator", icon: "ü§ù", description: "Add your first friend.", tier: "Bronze", points: 20 },
                        // Silver Tier
                        first_goal_completed: { name: "Quest Complete", icon: "üéâ", description: "Complete your first quest.", tier: "Silver", points: 50 },
                        week_streak: { name: "On Fire", icon: "üî•", description: "Maintain a 7-day streak.", tier: "Silver", points: 75 },
                        template_sharer: { name: "Architect", icon: "üèóÔ∏è", description: "Share your first quest template.", tier: "Silver", points: 50 },
                        first_journey_started: { name: "The Journey Begins", icon: "üó∫Ô∏è", description: "Start your first Mastery Journey.", tier: "Silver", points: 40 },
                        challenge_participant: { name: "Team Player", icon: "üåê", description: "Join a Community Challenge.", tier: "Silver", points: 30 },
                        strategist: { name: "Strategist", icon: "‚ôüÔ∏è", description: "Use a goal template.", tier: "Silver", points: 25 },
                        // Gold Tier
                        level_10: { name: "Chapter 10", icon: "‚≠ê", description: "Reach Chapter 10.", tier: "Gold", points: 100 },
                        perfect_week: { name: "Perfect Week", icon: "üíØ", description: "Complete a task every day for a week.", tier: "Gold", points: 200 },
                        goal_master: { name: "Quest Master", icon: "üëë", description: "Complete 10 quests.", tier: "Gold", points: 150 },
                        first_journey_completed: { name: "Pathfinder", icon: "üß≠", description: "Complete your first Mastery Journey.", tier: "Gold", points: 250 },
                        squad_leader: { name: "Squad Leader", icon: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶", description: "Have 5 friends on your list.", tier: "Gold", points: 100 },
                        // Platinum Tier
                        level_25: { name: "Chapter 25", icon: "üåü", description: "Reach Chapter 25.", tier: "Platinum", points: 250 },
                        month_streak: { name: "Unstoppable", icon: "üöÄ", description: "Maintain a 30-day streak.", tier: "Platinum", points: 500 },
                        all_categories: { name: "Jack of All Trades", icon: "üé®", description: "Complete a quest in every category.", tier: "Platinum", points: 300 },
                        journeyman: { name: "Journeyman", icon: "üß≥", description: "Complete 5 Mastery Journeys.", tier: "Platinum", points: 400 },
                        // Legendary Tier
                        level_50: { name: "Living Legend", icon: "üåå", description: "Reach Chapter 50.", tier: "Legendary", points: 1000 },
                        year_streak: { name: "Operator Prime", icon: "üèÜ", description: "Maintain a 365-day streak.", tier: "Legendary", points: 5000 },
                        community_pillar: { name: "Community Pillar", icon: "üèõÔ∏è", description: "Share 5 quest templates.", tier: "Legendary", points: 800 },
                    },
                    journeyTemplates: {
                        '30_day_wellness': { 
                            name: '30-Day Wellness Ascent', icon: 'üßò', category: 'Health',
                            description: 'A 30-day journey to build a consistent health and wellness routine, focusing on meditation, hydration, and movement.',
                            tasks: Array.from({length: 30}, (_, i) => `Day ${i+1}: Meditate for 5 mins, drink 8 glasses of water, and walk for 15 mins.`)
                        },
                        '90_day_focus': { 
                            name: '90-Day Focus Mastery', icon: 'üéØ', category: 'Learning',
                            description: 'A 90-day deep dive into mastering focus and eliminating distractions through structured work blocks and digital detoxes.',
                            tasks: Array.from({length: 90}, (_, i) => `Day ${i+1}: Complete two 45-minute deep work sessions with no distractions.`)
                        },
                        'learn_language': {
                            name: '180-Day Language Acquisition', icon: 'üó£Ô∏è', category: 'Learning',
                            description: 'A six-month journey to achieve conversational fluency in a new language through daily practice.',
                            tasks: Array.from({length: 180}, (_, i) => `Day ${i+1}: Practice 20 minutes of vocabulary flashcards and one 10-minute listening exercise.`)
                        },
                        'fitness_transformation': {
                            name: '120-Day Fitness Transformation', icon: 'üí™', category: 'Health',
                            description: 'A four-month structured program to build strength and endurance, alternating between workout days and active recovery.',
                            tasks: Array.from({length: 120}, (_, i) => `Day ${i+1}: ${i % 2 === 0 ? 'Complete your scheduled strength workout.' : 'Perform 30 minutes of light cardio or stretching.'}`)
                        },
                        'side_hustle': {
                            name: '100-Day Side Hustle Launch', icon: 'üöÄ', category: 'Work',
                            description: 'A guided 100-day sprint to take a side project from idea to launch, focusing on consistent, incremental progress.',
                            tasks: Array.from({length: 100}, (_, i) => `Day ${i+1}: Dedicate 1 hour to your side project, focusing on the next most important task.`)
                        },
                        'mindful_morning': {
                            name: '21-Day Mindful Morning', icon: 'üåÖ', category: 'Personal',
                            description: 'Cultivate a peaceful and productive morning routine over 21 days, incorporating mindfulness and intention setting.',
                            tasks: Array.from({length: 21}, (_, i) => `Day ${i+1}: Upon waking, avoid your phone for 15 mins and practice 5 minutes of gratitude journaling.`)
                        },
                        'financial_cleanup': {
                            name: '60-Day Financial Cleanup', icon: 'üßπ', category: 'Finance',
                            description: 'A two-month journey to organize your finances, create a budget, and start an automated savings plan.',
                            tasks: Array.from({length: 60}, (_, i) => `Day ${i+1}: Track all expenses for today and categorize them in your budget spreadsheet.`)
                        },
                        'creative_writing': {
                            name: '30-Day Creative Writing Habit', icon: '‚úçÔ∏è', category: 'Personal',
                            description: 'Build a consistent daily writing habit by writing just 100 words a day for 30 days.',
                            tasks: Array.from({length: 30}, (_, i) => `Day ${i+1}: Write at least 100 words on any topic of your choice.`)
                        },
                        'read_a_book': {
                            name: '14-Day Bookworm Challenge', icon: 'üìö', category: 'Learning',
                            description: 'Finish reading a book in two weeks by setting aside dedicated reading time each day.',
                            tasks: Array.from({length: 14}, (_, i) => `Day ${i+1}: Read for at least 20 minutes without distractions.`)
                        }
                    },
                    communityChallenges: [
                        { id: 'health_sprint_1', name: 'Global Health Sprint', description: 'Let\'s complete 100 Health tasks together as a community!', category: 'Health', goal: 100, reward: 200 },
                        { id: 'learning_marathon_1', name: 'Learning Marathon', description: 'The community goal is to complete 50 Learning tasks this month.', category: 'Learning', goal: 50, reward: 150 },
                        { id: 'creative_hour_1', name: 'Creative Hour Challenge', description: 'Let\'s log 200 hours of creative work this month!', category: 'Personal', goal: 200, reward: 250 },
                        { id: 'finance_sprint_1', name: 'Financial Literacy Sprint', description: 'Complete 75 Finance-related tasks as a community to boost our collective wealth.', category: 'Finance', goal: 75, reward: 150 },
                        { id: 'productivity_push_1', name: 'Global Productivity Push', description: 'Can we complete 500 Work tasks together this quarter?', category: 'Work', goal: 500, reward: 500 }
                    ],
                    colorSchemes: {
                        'Firewall Flare': '#f97316', 'Kernel Cobalt': '#007BFF', 'Sudo Violet': '#9D00FF',
                        'Terminal Teal': '#28a745', 'Glitch Magenta': '#E0115F', 'Static Cyan': '#00A3A3',
                        'Cache Gold': '#FFD700', 'Ruby Redux': '#D1001F',
                    },
                    goalTemplates: [
                        { name: "Run a 5k", category: "Health", title: "Train for and Complete a 5k Race", description: "Follow a structured training plan to build endurance and successfully run a 5k.", tasks: ["Research and choose a beginner 5k training plan.", "Buy proper running shoes.", "Complete Week 1 of training.", "Complete Week 2 of training.", "Sign up for a local 5k race.", "Practice running the full 5k distance at least once before race day.", "Rest and hydrate properly the day before the race."] },
                        { name: "Learn a New Skill", category: "Learning", title: "Learn the Basics of a New Skill", description: "Dedicate time to learning the fundamentals of a new skill (e.g., coding, a musical instrument, a language).", tasks: ["Identify the skill and key learning resources (books, courses).", "Dedicate 30 minutes per day to practice/study.", "Complete an introductory online course or tutorial.", "Create a small project using the new skill.", "Get feedback from a more experienced person."] },
                        { name: "Emergency Fund", category: "Finance", title: "Build a 3-Month Emergency Fund", description: "Systematically save to cover three months of essential living expenses.", tasks: ["Calculate your total monthly essential expenses.", "Determine your final savings goal (expenses x 3).", "Open a dedicated high-yield savings account.", "Set up an automatic weekly or monthly transfer.", "Track your progress towards the goal."] },
                        { name: "Digital Detox", category: "Personal", title: "Complete a Digital Detox Weekend", description: "Disconnect from all screens for a full weekend to recharge and refocus.", tasks: ["Schedule a weekend and inform friends/family.", "Plan non-digital activities (reading, hiking, etc.).", "Delete social media apps from your phone for the weekend.", "Turn off all non-essential notifications.", "Write a reflection on the experience afterward."] },
                        { name: "Master a Software", category: "Work", title: "Master a New Software Tool", description: "Become proficient in a key software tool relevant to your career.", tasks: ["Identify the target software (e.g., Figma, Excel, a CRM).", "Find and enroll in a top-rated online course.", "Complete the course and all its exercises.", "Apply the new skills to a real-world project.", "Create a portfolio piece showcasing your new proficiency."] },
                        { name: "SMART Goal", category: "Personal", title: "Set a SMART Goal", description: "Use the SMART framework for effective goal setting.", tasks: ["Make your goal Specific.", "Make your goal Measurable.", "Make your goal Achievable.", "Make your goal Relevant.", "Make your goal Time-bound."] },
                        { name: "OKR Setup", category: "Work", title: "Set Quarterly OKRs", description: "Define Objectives and Key Results for the quarter.", tasks: ["Define 3-5 key objectives.", "For each objective, define 3-5 measurable key results.", "Align OKRs with team/company goals.", "Schedule mid-quarter review.", "Track weekly progress."] },
                        { name: "WOOP Goal", category: "Learning", title: "Use WOOP Method for Goal Achievement", description: "Wish, Outcome, Obstacle, Plan - a scientific approach to goal setting.", tasks: ["State your Wish.", "Visualize the Outcome.", "Identify potential Obstacles.", "Create an If-Then Plan to overcome obstacles."] },
                        { name: "Habit Stacking", category: "Health", title: "Build a New Habit Stack", description: "Stack new habits onto existing ones for easier adoption.", tasks: ["Choose an existing habit as anchor.", "Select a new habit to stack.", "Define the sequence.", "Practice the stack daily.", "Track consistency for 21 days."] },
                        { name: "Eisenhower Matrix", category: "Work", title: "Prioritize Tasks with Eisenhower Matrix", description: "Sort tasks by urgency and importance.", tasks: ["List all current tasks.", "Categorize each as Urgent/Important, Urgent/Not Important, Not Urgent/Important, or Not Urgent/Not Important.", "Do Urgent/Important tasks immediately.", "Schedule Not Urgent/Important tasks.", "Delegate or delete others."] }
                    ],
                    particleOptions: {
                        Mentor: { particles: { move: { speed: 0.5, direction: "none" }, opacity: { value: 0.5 } } },
                        Competitor: { particles: { move: { speed: 2, direction: "top" }, opacity: { value: 0.8 } } },
                        Achiever: { particles: { move: { speed: 1, direction: "none" }, size: { value: 2.5 } } },
                        Explorer: { particles: { move: { speed: 0.8, random: true, straight: false }, opacity: { anim: { enable: true, speed: 1 } } } }
                    }
                },

                // --- INITIALIZATION ---
                async init() {
                    // Fetch Firebase config from Netlify function
                    try {
                        const response = await fetch('/.netlify/functions/config');
                        if (!response.ok) throw new Error('Failed to fetch Firebase config');
                        const config = await response.json();
                        
                        // Initialize Firebase
                        const firebaseApp = initializeApp(config.firebaseConfig);
                        auth = getAuth(firebaseApp);
                        db = getFirestore(firebaseApp);
                        this.state.firebaseReady = true;

                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        document.getElementById('loading-overlay').innerHTML = `<p style="color:red;">Error: Could not connect to services. Please refresh.</p>`;
                        return;
                    }

                    this.ui.initTheme();
                    this.router.init();
                    this.eventListeners.init();
                    this.ui.initLuckyWheel();
                    this.audio.init();
                    this.ui.initMatrixRain();

                    // The main entry point is now the auth state listener
                    this.auth.listenForAuthState();
                },
                
                // --- RESOURCE CLEANUP ---
                cleanup() {
                    // Unsubscribe from all Firestore listeners
                    if (unsubscribeUser) unsubscribeUser();
                    if (unsubscribeGoals) unsubscribeGoals();
                    if (unsubscribeCommunityTemplates) unsubscribeCommunityTemplates();
                    if (unsubscribeLeaderboard) unsubscribeLeaderboard();
                    if (unsubscribeChallenges) unsubscribeChallenges();
                    if (unsubscribeFriends) unsubscribeFriends();

                    if (this.state.energyInterval) clearInterval(this.state.energyInterval);
                    if (this.state.matrixInterval) clearInterval(this.state.matrixInterval);
                    if (this.state.particlesInstance) this.state.particlesInstance.stop();

                    this.state.currentUser = null;
                    this.state.userData = null;
                    this.state.localGoals = {};
                    this.state.friendsData = [];
                },

                // --- AUTHENTICATION (NOW WITH FIREBASE) ---
                auth: {
                    listenForAuthState() {
                        onAuthStateChanged(auth, user => {
                            if (user) {
                                // User is signed in
                                app.state.currentUser = user;
                                app.firestore.listenForUserData(user.uid);
                                app.firestore.listenForGoals(user.uid);
                                app.firestore.listenForCommunityTemplates();
                                app.firestore.listenForLeaderboard();
                                app.firestore.listenForChallenges();
                                app.ui.restartBackgroundEffects();
                            } else {
                                // User is signed out
                                app.cleanup();
                                app.router.navigateTo('auth');
                                document.getElementById('loading-overlay').style.opacity = '0';
                                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
                            }
                        });
                    },
                    async register(name, email, password) {
                        try {
                            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            const user = userCredential.user;

                            // Create a new user document in Firestore
                            const newUserDoc = {
                                uid: user.uid, email: user.email, displayName: name, createdAt: serverTimestamp(),
                                stats: { points: 0, level: 1, currentStreak: 0, lastCompletedDate: null, totalGoals: 0, completedGoals: 0, dailyCompletions: {}, bestStreak: 0, bestDay: { date: null, count: 0 }, lastLogin: null, tasksUntilChest: 10, energy: { value: 100, lastUpdated: new Date().toISOString() } },
                                achievements: [], inventory: { streakProtection: 0 },
                                settings: { theme: 'dark', colorScheme: 'Firewall Flare', motivationalStyle: 'Mentor', aiProvider: 'none' },
                                moods: {},
                                characterStats: { discipline: 0, creativity: 0, focus: 0, wellness: 0 },
                                journeys: {},
                                joinedChallenges: [],
                                friends: [],
                                isNewUser: true
                            };
                            await setDoc(doc(db, "users", user.uid), newUserDoc);
                            app.ui.showToast('Registration successful! Onboarding initiated.', 'success');
                            // onAuthStateChanged will handle the rest
                        } catch (error) {
                            app.ui.showToast(error.message, 'error');
                            console.error("Registration Error:", error);
                        }
                    },
                    async login(email, password) {
                        try {
                            await signInWithEmailAndPassword(auth, email, password);
                            // onAuthStateChanged will handle navigation
                        } catch (error) {
                            app.ui.showToast(error.message, 'error');
                            console.error("Login Error:", error);
                        }
                    },
                    async logout() {
                        try {
                            await signOut(auth);
                            app.ui.showToast('You have been logged out.', 'info');
                        } catch (error) {
                            app.ui.showToast(error.message, 'error');
                        }
                    },
                    async deleteAccount() {
                        app.ui.showConfirm(
                            'Delete Account?',
                            'DANGER: This will permanently delete your account and all associated data from the cloud. This action cannot be undone.',
                            async () => {
                                try {
                                    const user = auth.currentUser;
                                    if (!user) return;
                                    
                                    // Delete all user's goals
                                    const goalsQuery = query(collection(db, "goals"), where("userId", "==", user.uid));
                                    const goalsSnapshot = await getDocs(goalsQuery);
                                    const batch = writeBatch(db);
                                    goalsSnapshot.forEach(doc => batch.delete(doc.ref));
                                    
                                    // Delete the user document
                                    batch.delete(doc(db, "users", user.uid));
                                    
                                    await batch.commit();
                                    
                                    // Finally, delete the auth user
                                    await deleteUser(user);
                                    
                                    app.ui.showToast('Account successfully deleted.', 'success');
                                } catch (error) {
                                    console.error("Error deleting account:", error);
                                    app.ui.showToast(`Error deleting account: ${error.message}. Please re-authenticate and try again.`, 'error');
                                }
                            }
                        );
                    }
                },
                
                // --- FIRESTORE DATA MANAGEMENT ---
                firestore: {
                    listenForUserData(uid) {
                        const userDocRef = doc(db, "users", uid);
                        unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const hadUserData = !!app.state.userData;
                                app.state.userData = { id: docSnap.id, ...docSnap.data() };
                                
                                // On first load for a session
                                if (!hadUserData) {
                                    app.ui.applyUserSettings();
                                    app.gamification.dailyLogin();
                                    app.gamification.startEnergySystem();
                                    app.router.navigateTo('dashboard');
                                    app.ui.showToast(`Welcome back, ${app.state.userData.displayName}!`, 'success');
                                    
                                    if (app.state.userData.isNewUser) {
                                        app.ui.showProfileAnalysisModal();
                                        updateDoc(userDocRef, { isNewUser: false });
                                    } else if (!localStorage.getItem('tutorial_completed')) {
                                        app.ui.showTutorialModal();
                                        localStorage.setItem('tutorial_completed', 'true');
                                    }

                                    setTimeout(() => {
                                        document.getElementById('loading-overlay').style.opacity = '0';
                                        setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
                                    }, 500);
                                }

                                // Listen for friends data if it has changed
                                if (JSON.stringify(app.state.userData.friends) !== JSON.stringify(app.state.friendsData.map(f => f.id))) {
                                    this.listenForFriendsData(app.state.userData.friends);
                                }
                                
                                // Always update UI when data changes
                                app.ui.update();
                            } else {
                                console.error("User document not found!");
                                app.auth.logout();
                            }
                        }, error => {
                            console.error("Error listening to user data:", error);
                            app.ui.showToast("Connection error. Please refresh.", "error");
                        });
                    },
                    listenForGoals(uid) {
                        if (unsubscribeGoals) unsubscribeGoals();
                        const q = query(collection(db, "goals"), where("userId", "==", uid));
                        unsubscribeGoals = onSnapshot(q, (querySnapshot) => {
                            const goals = {};
                            querySnapshot.forEach((doc) => {
                                goals[doc.id] = { id: doc.id, ...doc.data() };
                            });
                            app.state.localGoals = goals;
                            if (app.state.activeView === 'goals' || app.state.activeView === 'calendar') {
                                app.ui.update();
                            }
                        }, error => console.error("Error listening to goals:", error));
                    },
                    listenForCommunityTemplates() {
                        if (unsubscribeCommunityTemplates) unsubscribeCommunityTemplates();
                        const q = query(collection(db, "communityTemplates"));
                        unsubscribeCommunityTemplates = onSnapshot(q, (querySnapshot) => {
                            const templates = {};
                            querySnapshot.forEach((doc) => {
                                templates[doc.id] = { id: doc.id, ...doc.data() };
                            });
                            app.state.communityTemplates = templates;
                        }, error => console.error("Error listening to templates:", error));
                    },
                    listenForLeaderboard() {
                        if (unsubscribeLeaderboard) unsubscribeLeaderboard();
                        const q = query(collection(db, "users"));
                        unsubscribeLeaderboard = onSnapshot(q, (querySnapshot) => {
                            const users = [];
                            querySnapshot.forEach((doc) => {
                                users.push({ id: doc.id, ...doc.data() });
                            });
                            app.state.leaderboardData = users.sort((a,b) => (b.stats?.points || 0) - (a.stats?.points || 0));
                            if (app.state.activeView === 'community') {
                                app.ui.renderLeaderboard();
                            }
                        }, error => console.error("Error listening to leaderboard:", error));
                    },
                    listenForFriendsData(friendUids) {
                        if (unsubscribeFriends) unsubscribeFriends();
                        if (!friendUids || friendUids.length === 0) {
                            app.state.friendsData = [];
                            if (app.state.activeView === 'community') app.ui.renderFriendsList();
                            return;
                        }
                        const q = query(collection(db, "users"), where("uid", "in", friendUids));
                        unsubscribeFriends = onSnapshot(q, (querySnapshot) => {
                            const friends = [];
                            querySnapshot.forEach((doc) => {
                                friends.push({ id: doc.id, ...doc.data() });
                            });
                            app.state.friendsData = friends;
                            if (app.state.activeView === 'community') {
                                app.ui.renderFriendsList();
                            }
                        }, error => console.error("Error listening to friends:", error));
                    },
                    listenForChallenges() {
                        if (unsubscribeChallenges) unsubscribeChallenges();
                        const q = query(collection(db, "globalChallenges"));
                        unsubscribeChallenges = onSnapshot(q, (querySnapshot) => {
                            const challenges = {};
                            querySnapshot.forEach((doc) => {
                                challenges[doc.id] = { id: doc.id, ...doc.data() };
                            });
                            app.state.globalChallenges = challenges;
                             if (app.state.activeView === 'community') {
                                app.ui.renderCommunityChallenges();
                            }
                        }, error => console.error("Error listening to challenges:", error));
                    },
                    async updateUserData(data) {
                        if (!app.state.currentUser) return;
                        const userDocRef = doc(db, "users", app.state.currentUser.uid);
                        await updateDoc(userDocRef, data);
                    }
                },

                // --- ROUTER & UI ---
                router: {
                    init() {
                        document.querySelectorAll('.nav-item a').forEach(link => {
                            link.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo(e.currentTarget.dataset.view); });
                        });
                    },
                    navigateTo(view) { app.state.activeView = view; app.ui.update(); }
                },
                ui: {
                    update() {
                        const { currentUser, userData, activeView } = app.state;
                        
                        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                        document.getElementById('auth-view').classList.add('hidden');
                        document.getElementById('sidebar').classList.add('hidden');
                        document.getElementById('app-header').classList.add('hidden');

                        if (currentUser && userData) {
                            document.getElementById('sidebar').classList.remove('hidden');
                            document.getElementById('app-header').classList.remove('hidden');
                            document.getElementById(`${activeView}-view`).classList.remove('hidden');
                            
                            document.querySelectorAll('.nav-item a').forEach(a => a.classList.toggle('active', a.dataset.view === activeView));
                            document.getElementById('view-title').textContent = activeView.charAt(0).toUpperCase() + activeView.slice(1);
                            const showGoalButtons = activeView === 'goals';
                            document.getElementById('add-goal-btn').classList.toggle('hidden', !showGoalButtons);
                            document.getElementById('add-goal-template-btn').classList.toggle('hidden', !showGoalButtons);
                            document.getElementById('profile-name').textContent = userData.displayName;
                            document.getElementById('profile-email').textContent = userData.email;
                            document.getElementById('user-id-display').textContent = currentUser.uid;

                            switch (activeView) {
                                case 'dashboard': this.renderDashboard(); break;
                                case 'goals': this.renderGoals(); break;
                                case 'journeys': this.renderJourneys(); break;
                                case 'calendar': this.renderCalendar(); break;
                                case 'community': this.renderCommunity(); break;
                                case 'achievements': this.renderAchievements(); break;
                                case 'settings': this.renderSettings(); break;
                            }
                        } else if (!currentUser) {
                            document.getElementById('auth-view').classList.remove('hidden');
                        }
                    },
                    renderDashboard() {
                        if (!app.state.userData) return;
                        const stats = app.state.userData.stats;
                        this.animateCounter('dashboard-points', stats.points);
                        this.animateCounter('dashboard-energy', Math.floor(stats.energy.value));
                        this.animateCounter('dashboard-level', stats.level);
                        this.animateCounter('dashboard-streak', stats.currentStreak, 'üî• ');
                        
                        const levelInfo = app.gamification.getLevelInfo(stats.level);
                        const progress = ((stats.points - levelInfo.baseXP) / (levelInfo.nextLevelXP - levelInfo.baseXP)) * 100;
                        document.getElementById('level-progress-bar').style.width = `${Math.min(progress, 100)}%`;
                        document.getElementById('level-progress-text').textContent = `${stats.points - levelInfo.baseXP} / ${levelInfo.nextLevelXP - levelInfo.baseXP} XP to Chapter ${stats.level + 1}`;
                        
                        document.getElementById('energy-progress-bar').style.width = `${stats.energy.value}%`;
                        document.getElementById('energy-level-text').textContent = `${Math.floor(stats.energy.value)} / 100`;

                        this.renderWeeklyChart();
                        this.renderTreasureChest();
                        this.renderCharacterStats();
                        app.gamification.getAIMentorMessage();
                    },
                    renderGoals() {
                        const { showingArchived } = app.state;
                        const goalList = document.getElementById('goal-list');
                        goalList.innerHTML = '';
                        document.getElementById('goals-view-title').textContent = showingArchived ? 'Archived Quests' : 'Active Quests';
                        document.getElementById('show-active-goals-btn').classList.toggle('active', !showingArchived);
                        document.getElementById('show-archived-goals-btn').classList.toggle('active', showingArchived);

                        const allUserGoals = Object.values(app.state.localGoals);
                        const topLevelGoals = allUserGoals.filter(g => !g.parentId && g.isArchived === showingArchived);
                        
                        document.getElementById('no-goals-message').classList.toggle('hidden', topLevelGoals.length > 0);
                        
                        topLevelGoals.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)).forEach(goal => {
                            goalList.appendChild(this.createGoalElement(goal.id, allUserGoals));
                        });
                    },
                    createGoalElement(goalId, allGoals) {
                        const goal = app.state.localGoals[goalId];
                        if (!goal) return document.createElement('div'); // Return empty element if goal not found
                        const li = document.createElement('li');
                        li.className = 'goal-item';
                        li.dataset.id = goal.id;

                        const children = allGoals.filter(g => g.parentId === goalId);
                        
                        let actionButtons = `
                            <button class="btn btn-sm btn-outline goal-edit-btn">Edit</button>
                            <button class="btn btn-sm btn-outline complete-all-tasks-btn">Complete All</button>
                            <button class="btn btn-sm btn-secondary share-template-btn">Share as Template</button>
                            <button class="btn btn-sm btn-danger goal-delete-btn">Archive</button>
                        `;
                        if (goal.isArchived) {
                            actionButtons = `
                                <button class="btn btn-sm btn-secondary goal-unarchive-btn">Restore</button>
                                <button class="btn btn-sm btn-danger goal-delete-btn">Delete Permanently</button>
                            `;
                        }

                        const completedTasks = Object.values(goal.tasks || {}).filter(t => t.isCompleted).length;
                        const totalTasks = Object.values(goal.tasks || {}).length;
                        const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                        li.innerHTML = `
                            <div class="goal-header">
                                <span class="toggle-icon">‚ñº</span>
                                <strong class="goal-title">${goal.title}</strong>
                                <span class="badge" style="font-size:0.8rem; color: var(--text-muted-color);">${goal.category}</span>
                                <span class="progress-status">${progress}%</span>
                            </div>
                            <div class="progress-bar-small"><div class="progress-bar-fill-small" style="width: ${progress}%"></div></div>
                            <div class="goal-content">
                                <p style="color: var(--text-muted-color); margin-bottom: 1rem;">${goal.description || ''}</p>
                                <ul class="task-list"></ul>
                                <ul class="subgoal-list"></ul>
                                <div class="goal-actions">
                                    <button class="btn btn-sm btn-primary add-subgoal-btn">+ Sub-Quest</button>
                                    <button class="btn btn-sm btn-primary add-task-btn">+ Task</button>
                                    ${actionButtons}
                                </div>
                            </div>
                        `;

                        const taskListEl = li.querySelector('.task-list');
                        const tasks = Object.values(goal.tasks || {}).sort((a, b) => a.order - b.order);
                        tasks.forEach(task => taskListEl.appendChild(this.createTaskElement(task)));

                        const subgoalListEl = li.querySelector('.subgoal-list');
                        children.forEach(childGoal => subgoalListEl.appendChild(this.createGoalElement(childGoal.id, allGoals)));
                        
                        li.querySelector('.goal-header').addEventListener('click', (e) => {
                            if (e.target.closest('.goal-actions') || e.target.closest('button')) return;
                            li.querySelector('.goal-content').classList.toggle('collapsed');
                            li.querySelector('.toggle-icon').textContent = li.querySelector('.goal-content').classList.contains('collapsed') ? '‚ñ∫' : '‚ñº';
                        });

                        return li;
                    },
                    createTaskElement(task) {
                        const li = document.createElement('li');
                        li.className = 'task-item'; li.dataset.id = task.id; li.draggable = true;
                        const today = new Date().setHours(0,0,0,0);
                        const dueDate = task.dueDate ? new Date(task.dueDate).setHours(0,0,0,0) : null;
                        const isOverdue = dueDate && dueDate < today && !task.isCompleted;

                        let subtaskHTML = '';
                        if (task.subTasks && task.subTasks.length > 0) {
                            subtaskHTML += '<ul class="subtask-list">';
                            task.subTasks.forEach((sub, index) => {
                                subtaskHTML += `
                                    <li class="subtask-item ${sub.isCompleted ? 'completed' : ''}">
                                        <input type="checkbox" class="subtask-checkbox" data-index="${index}" ${sub.isCompleted ? 'checked' : ''}>
                                        <span>${sub.description}</span>
                                    </li>
                                `;
                            });
                            subtaskHTML += '</ul>';
                        }

                        li.innerHTML = `
                            <div style="display: flex; flex-direction: column; width: 100%;">
                                <div class="task-item-main">
                                    <input type="checkbox" class="task-checkbox" ${task.isCompleted ? 'checked' : ''}>
                                    <span class="task-description ${task.isCompleted ? 'completed' : ''}">${task.description}</span>
                                    <button class="btn btn-sm btn-icon btn-outline ai-breakdown-btn" title="Break down task with AI">‚ú®</button>
                                    <span class="task-due-date ${isOverdue ? 'overdue' : ''}">${task.dueDate || ''}</span>
                                </div>
                                ${subtaskHTML}
                            </div>
                        `;
                        return li;
                    },
                    renderAchievements() {
                        const gallery = document.getElementById('achievement-gallery'); gallery.innerHTML = '';
                        if (!app.state.userData) return;
                        const userAchievements = app.state.userData.achievements;
                        for (const id in app.state.achievements) {
                            const achievement = app.state.achievements[id];
                            const unlocked = userAchievements.includes(id);
                            const badge = document.createElement('div');
                            badge.className = `achievement-badge ${unlocked ? 'unlocked' : ''}`;
                            badge.dataset.id = id;
                            badge.innerHTML = `
                                <div class="badge-tier ${achievement.tier}">${achievement.tier}</div>
                                <div class="badge-icon">${achievement.icon}</div>
                                <strong>${achievement.name}</strong>
                                <p style="font-size: 0.8rem; color: var(--text-muted-color);">${achievement.description}</p>
                                <p style="font-size: 0.9rem; font-weight: bold; color: var(--accent-color);">+${achievement.points} Essence</p>
                            `;
                            gallery.appendChild(badge);
                        }
                    },
                    renderJourneys() {
                        const grid = document.getElementById('journey-grid'); grid.innerHTML = '';
                        if (!app.state.userData) return;
                        const userJourneys = app.state.userData.journeys;
                        for (const id in app.state.journeyTemplates) {
                            const template = app.state.journeyTemplates[id];
                            const card = document.createElement('div');
                            card.className = 'card journey-card';
                            card.dataset.journeyId = id;
                            
                            let statusHTML = `<button class="btn btn-primary start-journey-btn">Start Journey</button>`;
                            const journeyState = userJourneys[id];
                            if (journeyState) {
                                if (journeyState.status === 'completed') {
                                    statusHTML = `<div class="journey-status completed">Completed</div>`;
                                } else {
                                    statusHTML = `<div class="journey-status in-progress">In Progress</div>`;
                                }
                            }

                            card.innerHTML = `
                                <div class="journey-icon">${template.icon}</div>
                                <h4>${template.name}</h4>
                                <p style="color: var(--text-muted-color); font-size: 0.9rem; margin: 0.5rem 0;">${template.description}</p>
                                ${statusHTML}
                            `;
                            grid.appendChild(card);
                        }
                    },
                    renderCalendar() {
                        const { calendarDate } = app.state;
                        const month = calendarDate.getMonth();
                        const year = calendarDate.getFullYear();

                        document.getElementById('month-year-header').textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                        const daysContainer = document.getElementById('calendar-days');
                        daysContainer.innerHTML = '';

                        const firstDayOfMonth = new Date(year, month, 1).getDay();
                        const daysInMonth = new Date(year, month + 1, 0).getDate();

                        const tasksWithDueDates = Object.values(app.state.localGoals).flatMap(g => 
                            Object.values(g.tasks || {}).map(t => ({...t, goalId: g.id, goalTitle: g.title}))
                        ).filter(t => t.dueDate);

                        // Create cells for previous month's days
                        for (let i = 0; i < firstDayOfMonth; i++) {
                            const dayCell = document.createElement('div');
                            dayCell.className = 'calendar-day other-month';
                            daysContainer.appendChild(dayCell);
                        }

                        // Create cells for current month's days
                        for (let i = 1; i <= daysInMonth; i++) {
                            const dayCell = document.createElement('div');
                            dayCell.className = 'calendar-day';
                            const date = new Date(year, month, i);
                            const dateString = date.toISOString().split('T')[0];
                            dayCell.dataset.date = dateString;

                            const today = new Date();
                            if (date.setHours(0,0,0,0) === today.setHours(0,0,0,0)) {
                                dayCell.classList.add('today');
                            }
                            
                            dayCell.innerHTML = `<div class="day-number">${i}</div><div class="calendar-tasks"></div>`;
                            
                            const tasksForDay = tasksWithDueDates.filter(t => t.dueDate === dateString);
                            const tasksContainer = dayCell.querySelector('.calendar-tasks');
                            
                            tasksForDay.forEach(task => {
                                const taskEl = document.createElement('div');
                                taskEl.className = 'calendar-task';
                                taskEl.textContent = task.description;
                                taskEl.title = `${task.goalTitle}: ${task.description}`;
                                taskEl.draggable = true;
                                taskEl.dataset.taskId = task.id;
                                taskEl.dataset.goalId = task.goalId;

                                const dueDate = new Date(task.dueDate).setHours(0,0,0,0);
                                const todayDate = new Date().setHours(0,0,0,0);

                                if (task.isCompleted) {
                                    taskEl.classList.add('completed');
                                } else if (dueDate < todayDate) {
                                    taskEl.classList.add('overdue');
                                } else if (dueDate === todayDate) {
                                    taskEl.classList.add('today');
                                } else {
                                    taskEl.classList.add('upcoming');
                                }
                                tasksContainer.appendChild(taskEl);
                            });

                            daysContainer.appendChild(dayCell);
                        }
                    },
                    renderCommunity() {
                        this.renderLeaderboard();
                        this.renderCommunityChallenges();
                        this.renderFriendsList();
                    },
                    renderLeaderboard() {
                        const list = document.getElementById('leaderboard-list');
                        list.innerHTML = '';
                        app.state.leaderboardData.forEach((user, index) => {
                            const item = document.createElement('li');
                            item.className = 'leaderboard-item';
                            if (user.id === app.state.currentUser.uid) {
                                item.classList.add('current-user');
                            }
                            item.innerHTML = `
                                <span class="leaderboard-rank">${index + 1}</span>
                                <span class="leaderboard-name">${user.displayName}</span>
                                <span class="leaderboard-points">${user.stats?.points || 0}</span>
                            `;
                            list.appendChild(item);
                        });
                    },
                    renderCommunityChallenges() {
                        const list = document.getElementById('challenge-list');
                        list.innerHTML = '';
                        if (!app.state.userData) return;

                        app.state.communityChallenges.forEach(challengeDef => {
                            const challengeData = app.state.globalChallenges[challengeDef.id] || { progress: 0, completed: false };
                            const card = document.createElement('div');
                            card.className = 'card challenge-card';
                            
                            const progress = (challengeData.progress / challengeDef.goal) * 100;
                            const isJoined = app.state.userData.joinedChallenges.includes(challengeDef.id);

                            card.innerHTML = `
                                <h4>${challengeDef.name}</h4>
                                <p style="color: var(--text-muted-color); font-size: 0.9rem; margin: 0.5rem 0;">${challengeDef.description}</p>
                                <div class="progress-bar"><div class="progress-bar-fill challenge" style="width: ${progress}%;"></div></div>
                                <p style="text-align: right; font-size: 0.9rem; margin-top: 0.5rem;">${challengeData.progress} / ${challengeDef.goal}</p>
                                <button class="btn ${isJoined ? 'btn-secondary' : 'btn-primary'} join-challenge-btn" data-challenge-id="${challengeDef.id}" ${isJoined ? 'disabled' : ''}>
                                    ${isJoined ? 'Joined' : 'Join Challenge'}
                                </button>
                            `;
                            list.appendChild(card);
                        });
                    },
                    renderFriendsList() {
                        const list = document.getElementById('friend-list');
                        list.innerHTML = '';
                        if (app.state.friendsData.length === 0) {
                            list.innerHTML = `<p style="color: var(--text-muted-color); text-align: center;">Add friends using their User ID.</p>`;
                            return;
                        }
                        app.state.friendsData.forEach(friend => {
                            const item = document.createElement('li');
                            item.className = 'friend-item';
                            item.innerHTML = `
                                <span class="friend-name">${friend.displayName}</span>
                                <span class="friend-points">‚≠ê ${friend.stats?.level || 1} | üí∞ ${friend.stats?.points || 0}</span>
                            `;
                            list.appendChild(item);
                        });
                    },
                    renderWeeklyChart() {
                        const container = document.getElementById('weekly-chart'); container.innerHTML = '';
                        if (!app.state.userData) return;
                        const data = app.gamification.getWeeklyActivity();
                        const maxVal = Math.max(...data.map(d => d.value), 1);
                        const svgNS = "http://www.w3.org/2000/svg";
                        const svg = document.createElementNS(svgNS, "svg");
                        svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%");
                        svg.setAttribute("viewBox", "0 0 350 200");
                        
                        data.forEach((d, i) => {
                            const barHeight = (d.value / maxVal) * 160;
                            const bar = document.createElementNS(svgNS, "rect");
                            bar.setAttribute("x", i * 50 + 10); bar.setAttribute("y", 180 - barHeight);
                            bar.setAttribute("width", 30); bar.setAttribute("height", barHeight);
                            bar.setAttribute("fill", "var(--accent-color)"); bar.setAttribute("rx", "3");
                            svg.appendChild(bar);

                            const text = document.createElementNS(svgNS, "text");
                            text.setAttribute("x", i * 50 + 25); text.setAttribute("y", 195);
                            text.setAttribute("fill", "var(--text-muted-color)"); text.setAttribute("font-size", "12");
                            text.setAttribute("text-anchor", "middle"); text.textContent = d.label;
                            svg.appendChild(text);
                        });
                        container.appendChild(svg);
                    },
                    renderTreasureChest() {
                        if (!app.state.userData) return;
                        const stats = app.state.userData.stats;
                        const chestIcon = document.getElementById('chest-icon');
                        const chestText = document.getElementById('chest-progress-text');
                        if (stats.tasksUntilChest <= 0) {
                            chestIcon.classList.add('ready');
                            chestText.textContent = "Ready to open!";
                        } else {
                            chestIcon.classList.remove('ready');
                            chestText.textContent = `Complete ${stats.tasksUntilChest} more tasks`;
                        }
                    },
                    renderCharacterStats() {
                        const container = document.getElementById('character-stats-grid');
                        if (!container || !app.state.userData) return;
                        const stats = app.state.userData.characterStats;
                        const statMap = {
                            discipline: { label: 'Discipline', icon: '‚öñÔ∏è' },
                            creativity: { label: 'Creativity', icon: 'üí°' },
                            focus: { label: 'Focus', icon: 'üéØ' },
                            wellness: { label: 'Wellness', icon: '‚ù§Ô∏è‚Äçü©π' }
                        };
                        let html = '';
                        for (const stat in stats) {
                            html += `
                                <div class="stat-item">
                                    <span>${statMap[stat].icon} ${statMap[stat].label}</span>
                                    <strong>${stats[stat]}</strong>
                                </div>
                            `;
                        }
                        container.innerHTML = html;
                    },
                    openGoalModal(goal = null, parentId = null) {
                        const modal = document.getElementById('goal-modal'); document.getElementById('goal-form').reset();
                        document.getElementById('goal-parent-id-input').value = parentId || '';
                        if (goal) {
                            document.getElementById('goal-modal-title').textContent = 'Edit Quest';
                            document.getElementById('goal-id-input').value = goal.id;
                            document.getElementById('goal-title').value = goal.title;
                            document.getElementById('goal-description').value = goal.description;
                            document.getElementById('goal-category').value = goal.category;
                            document.getElementById('goal-priority').value = goal.priority;
                            document.getElementById('goal-due-date').value = goal.dueDate;
                        } else {
                            document.getElementById('goal-modal-title').textContent = parentId ? 'New Sub-Quest' : 'New Quest';
                            document.getElementById('goal-id-input').value = '';
                        }
                        modal.classList.add('active');
                    },
                    closeGoalModal() { document.getElementById('goal-modal').classList.remove('active'); },
                    showToast(message, type = 'success') {
                        const container = document.getElementById('toast-container');
                        const toast = document.createElement('div');
                        toast.className = `toast ${type}`; toast.textContent = message;
                        container.appendChild(toast);
                        setTimeout(() => toast.remove(), 5000);
                    },
                    showConfirm(title, text, onConfirm) {
                        const modal = document.getElementById('confirm-modal');
                        document.getElementById('confirm-title').textContent = title;
                        document.getElementById('confirm-text').textContent = text;
                        modal.classList.add('active');
                        const okBtn = document.getElementById('confirm-ok-btn');
                        const cancelBtn = document.getElementById('confirm-cancel-btn');
                        const close = () => modal.classList.remove('active');
                        okBtn.onclick = () => { close(); onConfirm(); };
                        cancelBtn.onclick = close;
                    },
                    initTheme() {
                        const themeToggle = document.getElementById('theme-toggle');
                        const savedTheme = localStorage.getItem('operator_uplift_theme_mode') || 'dark';
                        document.documentElement.setAttribute('data-theme', savedTheme);
                        themeToggle.checked = savedTheme === 'dark';
                        
                        themeToggle.addEventListener('change', () => {
                            const newTheme = themeToggle.checked ? 'dark' : 'light';
                            document.documentElement.setAttribute('data-theme', newTheme);
                            if (app.state.userData) {
                                app.firestore.updateUserData({ 'settings.theme': newTheme });
                            } else {
                                localStorage.setItem('operator_uplift_theme_mode', newTheme);
                            }
                            app.ui.applyUserSettings();
                        });
                        
                        this.applyTimeOfDayTheme();

                        try {
                            tsParticles.load("tsparticles", {
                                fpsLimit: 120, background: { color: { value: "transparent" } },
                                interactivity: { events: { onHover: { enable: false }, resize: true } },
                                particles: {
                                    color: { value: "var(--particle-color)" },
                                    links: { color: "var(--particle-color)", distance: 150, enable: true, opacity: 0.5, width: 1 },
                                    move: { direction: "none", enable: true, outModes: { default: "bounce" }, random: false, speed: 1, straight: false },
                                    number: { density: { enable: true, area: 800 }, value: 80 },
                                    opacity: { value: 0.5, },
                                    shape: { type: "circle" },
                                    size: { value: { min: 1, max: 3 } },
                                },
                                detectRetina: true,
                            }).then(container => {
                                app.state.particlesInstance = container;
                                if (app.state.userData) { this.applyUserSettings(); }
                            });
                        } catch (error) {
                            console.warn("tsParticles library not loaded or failed to initialize. Particle effects will be disabled.", error);
                        }
                    },
                    initMatrixRain() {
                        if (app.state.matrixInterval) clearInterval(app.state.matrixInterval);
                        const canvas = document.getElementById('matrix-rain-canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = window.innerWidth;
                        canvas.height = window.innerHeight;

                        const alphabet = '„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„Ç¨„Ç∂„ÉÄ„Éê„Éë„Ç§„Ç£„Ç≠„Ç∑„ÉÅ„Éã„Éí„Éü„É™„É∞„ÇÆ„Ç∏„ÉÇ„Éì„Éî„Ç¶„Ç•„ÇØ„Çπ„ÉÑ„Éå„Éï„É†„É¶„É•„É´„Ç∞„Ç∫„Éñ„ÉÖ„Éó„Ç®„Çß„Ç±„Çª„ÉÜ„Éç„Éò„É°„É¨„É±„Ç≤„Çº„Éá„Éô„Éö„Ç™„Ç©„Ç≥„ÇΩ„Éà„Éé„Éõ„É¢„É®„Éß„É≠„É≤„Ç¥„Çæ„Éâ„Éú„Éù„É¥„ÉÉ„É≥ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                        const fontSize = 16;
                        const columns = canvas.width / fontSize;
                        const rainDrops = Array.from({ length: columns }).map(() => 1);

                        const draw = () => {
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--matrix-rain-color').trim();
                            ctx.font = fontSize + 'px monospace';

                            for (let i = 0; i < rainDrops.length; i++) {
                                const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                                ctx.fillText(text, i * fontSize, rainDrops[i] * fontSize);
                                if (rainDrops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                                    rainDrops[i] = 0;
                                }
                                rainDrops[i]++;
                            }
                        };
                        app.state.matrixInterval = setInterval(draw, 50);
                        window.addEventListener('resize', () => {
                            canvas.width = window.innerWidth;
                            canvas.height = window.innerHeight;
                        });
                    },
                    restartBackgroundEffects() {
                        this.initMatrixRain();
                        if (app.state.particlesInstance) {
                            app.state.particlesInstance.start();
                        }
                    },
                    async applyUserSettings() {
                        if (!app.state.userData) return;
                        
                        const { colorScheme, motivationalStyle, theme } = app.state.userData.settings;
                        
                        document.documentElement.setAttribute('data-theme', theme);
                        document.getElementById('theme-toggle').checked = theme === 'dark';
                        this.applyTimeOfDayTheme();
                        this.applyColorScheme(colorScheme);
                        await this.applyMotivationalStyle(motivationalStyle);
                        
                        if (app.state.particlesInstance) {
                            const newParticleColor = getComputedStyle(document.documentElement).getPropertyValue('--particle-color').trim();
                            app.state.particlesInstance.options.particles.color.value = newParticleColor;
                            app.state.particlesInstance.options.particles.links.color = newParticleColor;
                            await app.state.particlesInstance.refresh();
                        }
                    },
                    hexToRgba(hex, alpha = 1) {
                        const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                    },
                    applyColorScheme(schemeName) {
                        const hex = app.state.colorSchemes[schemeName]; if (!hex) return;
                        const lightHex = this.lightenColor(hex, 20);
                        const glowRgba = this.hexToRgba(hex, 0.6);
                        const matrixRainRgba = this.hexToRgba(hex, document.documentElement.getAttribute('data-theme') === 'dark' ? 0.35 : 0.5);

                        document.documentElement.style.setProperty('--accent-color', hex);
                        document.documentElement.style.setProperty('--accent-color-light', lightHex);
                        document.documentElement.style.setProperty('--accent-color-glow', glowRgba);
                        document.documentElement.style.setProperty('--matrix-rain-color', matrixRainRgba);

                        this.updateFavicon(hex);
                        this.initLuckyWheel();
                        if (app.state.activeView === 'dashboard') { this.renderWeeklyChart(); }
                    },
                    async applyMotivationalStyle(styleName) {
                        if (!app.state.particlesInstance || !styleName) return;
                        const styleOptions = app.state.particleOptions[styleName];
                        if (styleOptions) {
                            app.state.particlesInstance.options.load(styleOptions);
                            await app.state.particlesInstance.refresh();
                        }
                    },
                    applyTimeOfDayTheme() {
                        const hour = new Date().getHours();
                        const theme = document.documentElement.getAttribute('data-theme');
                        let start, end;
                        if (theme === 'dark') {
                            if (hour >= 5 && hour < 8) { start = '#1e3a8a'; end = '#312e81'; } // Dawn
                            else if (hour >= 8 && hour < 17) { start = '#0c4a6e'; end = '#1e3a8a'; } // Day
                            else if (hour >= 17 && hour < 20) { start = '#4c1d95'; end = '#1e1b4b'; } // Dusk
                            else { start = '#111827'; end = '#0a0a0a'; } // Night
                        } else {
                            if (hour >= 5 && hour < 8) { start = '#a5b4fc'; end = '#fbcfe8'; } // Dawn
                            else if (hour >= 8 && hour < 17) { start = '#bfdbfe'; end = '#a5f3fc'; } // Day
                            else if (hour >= 17 && hour < 20) { start = '#f5d0fe'; end = '#fecaca'; } // Dusk
                            else { start = '#f8fbff'; end = '#fafcff'; } // Night
                        }
                        document.documentElement.style.setProperty('--bg-gradient-start', start);
                        document.documentElement.style.setProperty('--bg-gradient-end', end);
                    },
                    renderSettings() {
                        this.renderColorSchemes();
                        if (!app.state.userData) return;
                        
                        const settings = app.state.userData.settings;
                        document.getElementById('motivational-style-select').value = settings.motivationalStyle;
                        const aiProviderSelect = document.getElementById('ai-provider-select');
                        aiProviderSelect.value = settings.aiProvider || 'none';
                        
                        aiProviderSelect.dispatchEvent(new Event('change'));
                    },
                    updateFavicon(hexColor) {
                        const color = hexColor.replace('#', '%23');
                        const favicon = document.getElementById('favicon');
                        const newFaviconHref = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path d='M25.0558 23.4284L16 28.5713L6.94421 23.4284V13.1427L16 8L25.0558 13.1427V23.4284Z' stroke='${color}' stroke-width='2'/><path d='M16 18.2857L16 8M16 18.2857L22.9282 22.1429M16 18.2857L9.0718 22.1429' stroke='${color}' stroke-width='1.5'/></svg>`;
                        favicon.href = newFaviconHref;
                    },
                    renderColorSchemes() {
                        const grid = document.getElementById('color-scheme-grid'); grid.innerHTML = '';
                        if (!app.state.userData) return;
                        const currentScheme = app.state.userData.settings.colorScheme;
                        for (const name in app.state.colorSchemes) {
                            const hex = app.state.colorSchemes[name];
                            const swatch = document.createElement('div');
                            swatch.className = 'color-swatch'; swatch.dataset.scheme = name;
                            if (name === currentScheme) { swatch.classList.add('active'); }
                            swatch.innerHTML = `<div class="color-swatch-preview" style="background-color: ${hex};"></div>${name}`;
                            grid.appendChild(swatch);
                        }
                    },
                    lightenColor(hex, percent) {
                        let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                        r = parseInt(r * (100 + percent) / 100); g = parseInt(g * (100 + percent) / 100); b = parseInt(b * (100 + percent) / 100);
                        r = (r<255)?r:255; g = (g<255)?g:255; b = (b<255)?b:255;  
                        const rr = ((r.toString(16).length==1)?"0"+r.toString(16):r.toString(16));
                        const gg = ((g.toString(16).length==1)?"0"+g.toString(16):g.toString(16));
                        const bb = ((b.toString(16).length==1)?"0"+b.toString(16):b.toString(16));
                        return `#${rr}${gg}${bb}`;
                    },
                    animateCounter(elementId, endValue, prefix = '') {
                        const element = document.getElementById(elementId); if (!element) return;
                        const startValue = parseInt(element.textContent.replace(prefix, '')) || 0;
                        if (startValue === endValue) {
                            element.textContent = prefix + endValue;
                            return;
                        };
                        const duration = 1000; let startTime = null;
                        function animation(currentTime) {
                            if (!startTime) startTime = currentTime;
                            const progress = Math.min((currentTime - startTime) / duration, 1);
                            const currentValue = Math.floor(progress * (endValue - startValue) + startValue);
                            element.textContent = prefix + currentValue;
                            if (progress < 1) { requestAnimationFrame(animation); }
                        }
                        requestAnimationFrame(animation);
                    },
                    triggerCelebration() {
                        const container = document.getElementById('celebration-container');
                        for (let i = 0; i < 30; i++) {
                            const firework = document.createElement('div');
                            firework.className = 'firework';
                            const x = Math.random() * 100;
                            const y = Math.random() * 100;
                            const delay = Math.random() * 1.5;
                            const color = Object.values(app.state.colorSchemes)[Math.floor(Math.random() * Object.values(app.state.colorSchemes).length)];
                            
                            firework.style.left = `${x}vw`;
                            firework.style.top = `${y}vh`;
                            firework.style.animationDelay = `${delay}s`;
                            firework.style.backgroundColor = color;
                            
                            container.appendChild(firework);
                            setTimeout(() => firework.remove(), 2000);
                        }
                    },
                    initLuckyWheel() {
                        const canvas = document.getElementById('lucky-wheel-canvas'); const ctx = canvas.getContext('2d');
                        const rewards = app.gamification.wheelRewards; const numSegments = rewards.length;
                        const angleStep = (2 * Math.PI) / numSegments;
                        function drawSegment(index, text) {
                            const startAngle = index * angleStep; const endAngle = startAngle + angleStep;
                            ctx.beginPath(); ctx.moveTo(150, 150); ctx.arc(150, 150, 150, startAngle, endAngle); ctx.closePath();
                            ctx.fillStyle = index % 2 === 0 ? '#3f3f46' : '#52525b'; ctx.fill(); ctx.stroke();
                            ctx.save(); ctx.translate(150, 150); ctx.rotate(startAngle + angleStep / 2);
                            ctx.textAlign = "right"; ctx.fillStyle = "#fff"; ctx.font = "bold 14px Inter";
                            ctx.fillText(text, 130, 10); ctx.restore();
                        }
                        function drawWheel() {
                            ctx.clearRect(0, 0, 300, 300); ctx.strokeStyle = 'var(--border-glass)';
                            rewards.forEach((reward, i) => drawSegment(i, reward.label));
                        }
                        drawWheel();
                    },
                    spinWheel() {
                        const canvas = document.getElementById('lucky-wheel-canvas'); const spinBtn = document.getElementById('spin-wheel-btn');
                        spinBtn.disabled = true;
                        const numSegments = app.gamification.wheelRewards.length;
                        const stopAngle = Math.random() * 360; const spinTime = 4000;
                        const spinAngle = (Math.random() * 10 + 10) * 360 + stopAngle;
                        canvas.style.transition = `transform ${spinTime}ms cubic-bezier(0.25, 1, 0.5, 1)`;
                        canvas.style.transform = `rotate(${spinAngle}deg)`;
                        setTimeout(() => {
                            canvas.style.transition = 'none'; const finalRotation = spinAngle % 360;
                            canvas.style.transform = `rotate(${finalRotation}deg)`;
                            const winningSegmentIndex = Math.floor(((360 - (finalRotation % 360) + 270) % 360) / (360 / numSegments));
                            app.gamification.claimWheelReward(winningSegmentIndex);
                            setTimeout(() => { document.getElementById('lucky-wheel-modal').classList.remove('active'); spinBtn.disabled = false; }, 1500);
                        }, spinTime);
                    },
                    showTutorialModal() { document.getElementById('tutorial-modal').classList.add('active'); },
                    showProfileAnalysisModal() { document.getElementById('profile-analysis-modal').classList.add('active'); },
                    showAddTaskModal(goalId) {
                        document.getElementById('add-task-goal-id').value = goalId;
                        document.getElementById('add-task-modal').classList.add('active');
                    },
                    showCalendarAddTaskModal(dateString) {
                        const modal = document.getElementById('calendar-add-task-modal');
                        document.getElementById('calendar-task-due-date').value = dateString;
                        const select = document.getElementById('calendar-task-goal-select');
                        select.innerHTML = '';

                        const userGoals = Object.values(app.state.localGoals).filter(g => !g.isArchived);
                        if(userGoals.length === 0) {
                            this.showToast('Create a Quest first before adding tasks!', 'info');
                            return;
                        }

                        userGoals.forEach(goal => {
                            const option = document.createElement('option');
                            option.value = goal.id;
                            option.textContent = goal.title;
                            select.appendChild(option);
                        });
                        
                        modal.classList.add('active');
                    },
                    async analyzeProfile(formData) {
                        const profileData = {
                            age: formData.get('age'), occupation: formData.get('occupation'),
                            goals: formData.get('goals'), strengths: formData.get('strengths'),
                            weaknesses: formData.get('weaknesses')
                        };
                        const messages = [
                            { role: 'system', content: 'You are an AI mentor. Analyze the user\'s profile and provide a summary of their identity, goals, situation, strengths, and weaknesses. Suggest initial goals or journeys based on this analysis. Output in a structured format.' },
                            { role: 'user', content: JSON.stringify(profileData) }
                        ];
                        try {
                            const analysis = await app.ai.call(messages);
                            document.getElementById('profile-analysis-results').textContent = analysis;
                            document.getElementById('profile-analysis-results').classList.remove('hidden');
                        } catch (e) {
                            app.ui.showToast(`Analysis failed: ${e.message}`, 'error');
                        }
                    }
                },
                
                // --- GOAL & TASK MANAGEMENT (NOW WITH FIRESTORE) ---
                goals: {
                    async save(goalData) {
                        const isNew = !goalData.id;
                        
                        if (isNew) {
                            const goalCollectionRef = collection(db, "goals");
                            goalData.userId = app.state.currentUser.uid;
                            goalData.createdAt = serverTimestamp();
                            goalData.completedAt = null;
                            goalData.isArchived = false; 
                            if (!goalData.tasks) { goalData.tasks = await this.generateTasksWithAI(goalData.title, goalData.category); }
                            
                            await addDoc(goalCollectionRef, goalData);
                            await app.firestore.updateUserData({ 'stats.totalGoals': increment(1) });
                            app.gamification.checkAchievement('first_goal');
                        } else {
                            const goalRef = doc(db, "goals", goalData.id);
                            const { id, ...dataToSave } = goalData;
                            await setDoc(goalRef, dataToSave, { merge: true });
                        }
                        
                        app.ui.closeGoalModal();
                        app.ui.showToast(`Quest ${isNew ? 'started' : 'updated'}.`, 'success');
                    },
                    async addTask(goalId, description, dueDate) {
                        const goalRef = doc(db, "goals", goalId);
                        const goal = app.state.localGoals[goalId];
                        if (!goal) return;
                        
                        const taskId = `task_${new Date().getTime()}`;
                        const order = Object.keys(goal.tasks || {}).length;
                        const newTask = { id: taskId, description, isCompleted: false, order, createdAt: new Date().toISOString(), completedAt: null, dueDate, subTasks: [] };
                        
                        await updateDoc(goalRef, { [`tasks.${taskId}`]: newTask });

                        app.ui.showToast('Task added!', 'success');
                    },
                    async delete(goalId, permanent = false) {
                        const goal = app.state.localGoals[goalId];
                        const message = permanent ? 'This will permanently delete this quest and all its sub-quests. This action cannot be undone.' : 'This will archive the quest and its sub-quests. You can restore it later.';
                        app.ui.showConfirm(permanent ? 'Delete Permanently?' : 'Archive Quest?', message, async () => {
                            if (goal && goal.journeyId && !permanent) {
                                await app.journeys.abandon(goal.journeyId);
                            }
                            const allIds = this.getGoalAndChildrenIds(goalId);
                            const batch = writeBatch(db);
                            
                            allIds.forEach(id => {
                                const goalDocRef = doc(db, "goals", id);
                                if (permanent) {
                                    batch.delete(goalDocRef);
                                } else {
                                    batch.update(goalDocRef, { isArchived: true });
                                }
                            });
                            
                            await batch.commit();
                            app.ui.showToast(permanent ? 'Quest permanently deleted.' : 'Quest archived.', 'success');
                        });
                    },
                    getGoalAndChildrenIds(goalId) {
                        let ids = [goalId];
                        const children = Object.values(app.state.localGoals).filter(g => g.parentId === goalId);
                        children.forEach(child => { ids = ids.concat(this.getGoalAndChildrenIds(child.id)); });
                        return ids;
                    },
                    async unarchive(goalId) {
                        const allIdsToRestore = this.getGoalAndChildrenIds(goalId);
                        const batch = writeBatch(db);
                        allIdsToRestore.forEach(id => {
                            const goalDocRef = doc(db, "goals", id);
                            batch.update(goalDocRef, { isArchived: false });
                        });
                        await batch.commit();
                        app.ui.showToast('Quest restored.', 'success');
                    },
                    async generateTasksWithAI(title, category) {
                        const provider = app.state.userData.settings.aiProvider;
                        if (provider && provider !== 'none') {
                            try {
                                app.ui.showToast(`Generating tasks with AI...`, 'info');
                                const messages = [
                                    { role: 'system', content: 'You are a helpful assistant. Generate 4 to 5 actionable initial tasks for the given goal title and category. Output ONLY a valid JSON array of strings, like ["Task 1", "Task 2"].' },
                                    { role: 'user', content: `Goal title: ${title}, Category: ${category}` }
                                ];
                                const responseText = await app.ai.call(messages);
                                const tasksDesc = JSON.parse(responseText);
                                const tasks = {};
                                tasksDesc.forEach((desc, index) => {
                                    const taskId = `task_${new Date().getTime()}_${index}`;
                                    tasks[taskId] = { id: taskId, description: desc, isCompleted: false, order: index, createdAt: new Date().toISOString(), completedAt: null, dueDate: null, subTasks: [] };
                                });
                                app.ui.showToast('AI-generated tasks ready!', 'success');
                                return tasks;
                            } catch (e) {
                                console.error("AI API Error:", e);
                                app.ui.showToast(`AI failed: ${e.message}. Using default tasks.`, 'error');
                            }
                        }

                        // Fallback static tasks
                        app.ui.showToast('Generating first steps for your quest...', 'info');
                        const staticTasks = {
                            Health: ["Define a specific health goal (e.g., walk 30 mins).", "Schedule time for it this week.", "Get any necessary gear ready.", "Tell a friend to keep you accountable."],
                            Learning: ["Find a primary learning resource (book, course).", "Schedule your first 30-minute study session.", "Set up your study space.", "Define what 'finished' looks like for this goal."],
                            Work: ["Break the goal into 3 smaller milestones.", "Identify the single most important first step.", "Block time on your calendar to work on it.", "Inform any stakeholders about your new goal."],
                            Finance: ["Review your current budget.", "Identify one area to save money.", "Set up an automatic transfer to savings.", "Track your spending for one week."],
                            Personal: ["Write down why this goal is important to you.", "Take the smallest possible first step.", "Schedule time for this goal on your calendar.", "Visualize yourself having achieved the goal."]
                        };
                        const taskDescriptions = staticTasks[category] || staticTasks['Personal'];
                        const tasks = {};
                        await new Promise(resolve => setTimeout(resolve, 500));
                        taskDescriptions.forEach((desc, index) => {
                            const taskId = `task_${new Date().getTime()}_${index}`;
                            tasks[taskId] = { id: taskId, description: desc, isCompleted: false, order: index, createdAt: new Date().toISOString(), completedAt: null, dueDate: null, subTasks: [] };
                        });
                        app.ui.showToast('Your first steps are ready!', 'success');
                        return tasks;
                    },
                    async toggleTask(goalId, taskId, taskElement) {
                        const goal = app.state.localGoals[goalId];
                        if (!goal || !goal.tasks || !goal.tasks[taskId]) return;
                        
                        const task = goal.tasks[taskId];
                        const newCompletedState = !task.isCompleted;
                        const completedAt = newCompletedState ? new Date().toISOString() : null;

                        const goalRef = doc(db, "goals", goalId);
                        await updateDoc(goalRef, {
                            [`tasks.${taskId}.isCompleted`]: newCompletedState,
                            [`tasks.${taskId}.completedAt`]: completedAt
                        });

                        if(newCompletedState) {
                            app.audio.playSound('taskComplete');
                            if (taskElement) {
                                taskElement.classList.add('completed-animation');
                                setTimeout(() => taskElement.classList.remove('completed-animation'), 500);
                            }
                            const bonusPoints = Math.floor(Math.random() * 6) + 5;
                            app.gamification.addPoints(10 + bonusPoints, goal.category);
                            app.gamification.modifyEnergy(5);
                            app.ui.showToast(`+${10 + bonusPoints} Essence! +5 Energy!`, 'success');
                            app.gamification.checkAchievement('first_task');
                            app.gamification.logDailyCompletion();
                            app.gamification.checkTreasureChest();
                            app.gamification.updateCommunityChallengeProgress(goal.category);
                        } else {
                            app.gamification.addPoints(-10, goal.category, true);
                        }
                        this.checkGoalCompletion(goalId);
                    },
                    async toggleSubTask(goalId, taskId, subTaskIndex) {
                        const task = app.state.localGoals[goalId]?.tasks?.[taskId];
                        if (!task || !task.subTasks) return;
                        
                        const newSubTasks = [...task.subTasks];
                        newSubTasks[subTaskIndex].isCompleted = !newSubTasks[subTaskIndex].isCompleted;
                        
                        const goalRef = doc(db, "goals", goalId);
                        await updateDoc(goalRef, { [`tasks.${taskId}.subTasks`]: newSubTasks });

                        if (newSubTasks.every(st => st.isCompleted)) {
                            if (!task.isCompleted) {
                                this.toggleTask(goalId, taskId, document.querySelector(`.task-item[data-id="${taskId}"]`));
                            }
                        } else {
                            if (task.isCompleted) {
                                this.toggleTask(goalId, taskId, document.querySelector(`.task-item[data-id="${taskId}"]`));
                            }
                        }
                    },
                    async checkGoalCompletion(goalId) {
                        const goal = app.state.localGoals[goalId];
                        if (!goal) return;
                        const allTasks = Object.values(goal.tasks || {});
                        if (allTasks.length > 0 && allTasks.every(t => t.isCompleted)) {
                            if (!goal.completedAt) {
                                const goalRef = doc(db, "goals", goalId);
                                await updateDoc(goalRef, { completedAt: serverTimestamp() });
                                
                                app.gamification.addPoints(50, goal.category); 
                                await app.firestore.updateUserData({ 'stats.completedGoals': increment(1) });
                                
                                app.ui.showToast(`Quest "${goal.title}" completed! +50 bonus Essence!`, 'success');
                                app.ui.triggerCelebration();
                                app.audio.playSound('levelUp');
                                app.gamification.checkAchievement('first_goal_completed');
                                app.gamification.checkAchievement('goal_master');
                                app.gamification.checkAchievement('all_categories');

                                if (goal.journeyId) {
                                    app.journeys.updateStatus(goal.journeyId);
                                }
                            }
                        }
                    },
                    async updateTaskOrder(goalId, orderedTaskIds) {
                        const goalRef = doc(db, "goals", goalId);
                        const goal = app.state.localGoals[goalId];
                        const updatedTasks = { ...goal.tasks };
                        orderedTaskIds.forEach((taskId, index) => { if (updatedTasks[taskId]) updatedTasks[taskId].order = index; });
                        await updateDoc(goalRef, { tasks: updatedTasks });
                    },
                    async updateTaskDescription(goalId, taskId, newDescription) {
                        const goalRef = doc(db, "goals", goalId);
                        await updateDoc(goalRef, { [`tasks.${taskId}.description`]: newDescription });
                    },
                    async updateTaskDueDate(goalId, taskId, newDueDate) {
                        const goalRef = doc(db, "goals", goalId);
                        await updateDoc(goalRef, { [`tasks.${taskId}.dueDate`]: newDueDate });
                        app.ui.showToast('Task rescheduled!', 'success');
                    },
                    async shareGoalAsTemplate(goalId) {
                        const goal = app.state.localGoals[goalId];
                        if (!goal) return;

                        const template = {
                            title: goal.title,
                            description: goal.description,
                            category: goal.category,
                            author: app.state.userData.displayName,
                            authorId: app.state.currentUser.uid,
                            createdAt: serverTimestamp(),
                            tasks: Object.values(goal.tasks || {}).map(task => ({ description: task.description }))
                        };
                        
                        await addDoc(collection(db, "communityTemplates"), template);

                        app.ui.showToast('Quest template shared with the community!', 'success');
                        app.gamification.checkAchievement('template_sharer');
                        app.gamification.checkAchievement('community_pillar');
                    },
                    async aiBreakdownTask(goalId, taskId) {
                        const goal = app.state.localGoals[goalId];
                        const task = goal?.tasks?.[taskId];
                        if (!task) return;

                        const provider = app.state.userData.settings.aiProvider;
                        if (!provider || provider === 'none') {
                            app.ui.showToast('Please select an AI Provider in Settings.', 'error');
                            return;
                        }
                        
                        app.ui.showToast('AI is breaking down the task...', 'info');
                        try {
                            const messages = [
                                { role: 'system', content: 'You are a helpful assistant. Break down the given task into a detailed, step-by-step checklist of 3-5 sub-tasks. The user\'s main goal is provided for context. Output ONLY a valid JSON array of strings for the sub-tasks, like ["Sub-task 1", "Sub-task 2"].' },
                                { role: 'user', content: `Main Goal: "${goal.title}"\nTask to break down: "${task.description}"` }
                            ];
                            const responseText = await app.ai.call(messages);
                            const subTaskDescriptions = JSON.parse(responseText);
                            
                            const newSubTasks = subTaskDescriptions.map(desc => ({ description: desc, isCompleted: false }));
                            
                            const goalRef = doc(db, "goals", goalId);
                            await updateDoc(goalRef, { [`tasks.${taskId}.subTasks`]: newSubTasks });
                            
                            app.ui.showToast('Task broken down into sub-steps!', 'success');
                        } catch (e) {
                            console.error("AI Breakdown Error:", e);
                            app.ui.showToast(`AI failed: ${e.message}.`, 'error');
                        }
                    },
                    async completeAllTasks(goalId) {
                        const goal = app.state.localGoals[goalId];
                        if (!goal) return;
                        
                        const goalRef = doc(db, "goals", goalId);
                        const updatedTasks = { ...goal.tasks };
                        let pointsToAdd = 0;
                        let energyToAdd = 0;
                        let tasksCompletedCount = 0;

                        Object.values(updatedTasks).forEach(task => {
                            if (!task.isCompleted) {
                                task.isCompleted = true;
                                task.completedAt = new Date().toISOString();
                                pointsToAdd += 10 + Math.floor(Math.random() * 6);
                                energyToAdd += 5;
                                tasksCompletedCount++;
                                app.gamification.logDailyCompletion();
                                app.gamification.checkTreasureChest();
                                app.gamification.updateCommunityChallengeProgress(goal.category);
                            }
                        });

                        if (tasksCompletedCount > 0) {
                            await updateDoc(goalRef, { tasks: updatedTasks });
                            app.gamification.addPoints(pointsToAdd, goal.category);
                            app.gamification.modifyEnergy(energyToAdd);
                            app.ui.showToast(`${tasksCompletedCount} tasks completed! +${pointsToAdd} Essence!`, 'success');
                            this.checkGoalCompletion(goalId);
                        } else {
                            app.ui.showToast('All tasks are already complete!', 'info');
                        }
                    }
                },
                
                // --- JOURNEY MANAGEMENT (NOW WITH FIRESTORE) ---
                journeys: {
                    async start(journeyId) {
                        const template = app.state.journeyTemplates[journeyId];
                        if (!template || app.state.userData.journeys[journeyId]) {
                            app.ui.showToast("Cannot start this journey.", "error");
                            return;
                        }

                        const tasks = {};
                        template.tasks.forEach((desc, index) => {
                            const taskId = `task_${new Date().getTime()}_${index}`;
                            tasks[taskId] = { id: taskId, description: desc, isCompleted: false, order: index, subTasks: [] };
                        });

                        const goalData = {
                            title: template.name,
                            description: template.description,
                            category: template.category,
                            priority: 'High',
                            tasks: tasks,
                            journeyId: journeyId
                        };
                        
                        await app.goals.save(goalData);
                        
                        await app.firestore.updateUserData({ [`journeys.${journeyId}`]: { status: 'in-progress', startDate: new Date().toISOString() } });
                        
                        app.gamification.checkAchievement('first_journey_started');
                        
                        app.ui.showToast(`Journey "${template.name}" has begun! Check your Goals.`, 'success');
                        document.getElementById('journey-modal').classList.remove('active');
                    },
                    async updateStatus(journeyId) {
                        const userJourney = app.state.userData.journeys[journeyId];
                        if (userJourney && userJourney.status !== 'completed') {
                            await app.firestore.updateUserData({
                                [`journeys.${journeyId}.status`]: 'completed',
                                [`journeys.${journeyId}.completedDate`]: new Date().toISOString()
                            });
                            
                            app.gamification.addPoints(250);
                            app.ui.showToast(`Journey Complete! +250 Essence!`, 'success');
                            app.ui.triggerCelebration();
                            app.audio.playSound('levelUp');
                            app.gamification.checkAchievement('first_journey_completed');
                            app.gamification.checkAchievement('journeyman');
                        }
                    },
                    async abandon(journeyId) {
                        if (app.state.userData.journeys[journeyId]) {
                            await app.firestore.updateUserData({ [`journeys.${journeyId}`]: deleteField() });
                            app.ui.showToast('Journey abandoned.', 'info');
                        }
                    },
                },

                // --- FRIEND MANAGEMENT (NOW WITH FIRESTORE) ---
                friends: {
                    async add(friendUid) {
                        const user = app.state.currentUser;
                        if (friendUid === user.uid) {
                            app.ui.showToast("You cannot add yourself as a friend.", "error");
                            return;
                        }
                        if (app.state.userData.friends.includes(friendUid)) {
                            app.ui.showToast("This user is already your friend.", "info");
                            return;
                        }
                        
                        const friendDocRef = doc(db, "users", friendUid);
                        const friendDoc = await getDoc(friendDocRef);
                        
                        if (!friendDoc.exists()) {
                            app.ui.showToast("User not found.", "error");
                            return;
                        }
                        
                        await app.firestore.updateUserData({ friends: arrayUnion(friendUid) });
                        
                        app.ui.showToast("Friend added successfully!", "success");
                        app.gamification.checkAchievement('first_friend');
                        app.gamification.checkAchievement('squad_leader');
                    }
                },

                // --- GAMIFICATION ENGINE (NOW WITH FIRESTORE) ---
                gamification: {
                    wheelRewards: [
                        { label: "+10 Essence", isPositive: true, action: () => app.gamification.addPoints(10) },
                        { label: "Streak Shield", isPositive: true, action: () => app.firestore.updateUserData({ 'inventory.streakProtection': increment(1) }).then(() => app.ui.showToast('Streak Shield acquired!', 'success')) },
                        { label: "+25 Essence", isPositive: true, action: () => app.gamification.addPoints(25) },
                        { label: "+10 Energy", isPositive: true, action: () => app.gamification.modifyEnergy(10) },
                        { label: "+50 Essence", isPositive: true, action: () => app.gamification.addPoints(50) },
                        { label: "Mentor Tip", isPositive: true, action: () => app.ui.showToast(app.gamification.getAITip(), 'info') }
                    ],
                    startEnergySystem() {
                        if (app.state.energyInterval) clearInterval(app.state.energyInterval);
                        app.state.energyInterval = setInterval(() => {
                            this.modifyEnergy(0);
                        }, 60000);
                    },
                    modifyEnergy(amount) {
                        if (!app.state.userData) return;
                        const energyState = app.state.userData.stats.energy;
                        const now = new Date();
                        const lastUpdated = new Date(energyState.lastUpdated);
                        const minutesPassed = (now - lastUpdated) / (1000 * 60);
                        const depletionRate = 1 / 15;
                        const depletion = minutesPassed * depletionRate;

                        let newEnergyValue = energyState.value - depletion + amount;
                        if (newEnergyValue > 100) newEnergyValue = 100;
                        if (newEnergyValue < 0) newEnergyValue = 0;
                        
                        app.firestore.updateUserData({
                            'stats.energy.value': newEnergyValue,
                            'stats.energy.lastUpdated': now.toISOString()
                        });
                    },
                    async dailyLogin() {
                        if (!app.state.userData) return;
                        const stats = app.state.userData.stats;
                        const today = new Date().toISOString().split('T')[0];
                        if (stats.lastLogin !== today) {
                            await this.updateStreak();
                            this.modifyEnergy(50);
                            app.ui.showToast(this.getMorningMotivation(), 'info');
                            app.ui.showToast('+50 Energy for logging in!', 'success');
                            
                            if (!app.state.userData.moods[today]) {
                                document.getElementById('mood-modal').classList.add('active');
                            } else {
                                document.getElementById('lucky-wheel-modal').classList.add('active');
                            }
                            await app.firestore.updateUserData({ 'stats.lastLogin': today });
                        }
                    },
                    getMorningMotivation() {
                        const name = app.state.userData.displayName;
                        const messages = [ `The saga continues, ${name}! A new day, a new chapter to write.`, `Let's get it, ${name}! What's the first quest on your list today?`, `Good morning, ${name}! Remember the hero you're becoming. You've got this.` ];
                        return messages[Math.floor(Math.random() * messages.length)];
                    },
                    claimWheelReward(index) {
                        const reward = this.wheelRewards[index];
                        app.ui.showToast(`You won: ${reward.label}!`, reward.isPositive ? 'success' : 'info');
                        if (reward.isPositive) { app.ui.triggerCelebration(); }
                        reward.action();
                    },
                    getAITip() {
                        const tips = ["Try breaking a big task into three smaller ones.", "Schedule your most important task for the morning.", "Reward yourself after completing a difficult task."];
                        return `Mentor says: "${tips[Math.floor(Math.random() * tips.length)]}"`;
                    },
                    async getAIMentorMessage() {
                        const mentorWidget = document.getElementById('ai-mentor-widget'); if (!mentorWidget || !app.state.userData) return;
                        const messageEl = mentorWidget.querySelector('.mentor-message');
                        const { displayName, stats, settings } = app.state.userData;
                        const provider = settings.aiProvider;
                        
                        if (provider && provider !== 'none') {
                            try {
                                const messages = [
                                    { role: 'system', content: `You are an AI mentor in the style of a "${settings.motivationalStyle}". Provide a short, punchy, and motivational message based on the user's stats. Keep it to 1-2 sentences.` },
                                    { role: 'user', content: `User: ${displayName}, Chapter: ${stats.level}, Essence: ${stats.points}, Energy: ${Math.floor(stats.energy.value)}, Streak: ${stats.currentStreak} days.` }
                                ];
                                messageEl.textContent = await app.ai.call(messages);
                                return;
                            } catch (e) {
                                console.error("AI API Error:", e);
                                messageEl.textContent = `AI Mentor is offline. Using standard message.`;
                            }
                        }
                        
                        const messages = {
                            Mentor: `The path to mastery is built one step at a time, ${displayName}. What will you accomplish today?`,
                            Competitor: `Your rivals are training, ${displayName}. Don't fall behind. Push your limits!`,
                            Achiever: `Another day to build your legacy, ${displayName}. Let's tick off those goals and climb higher.`,
                            Explorer: `What new discoveries await you today, ${displayName}? Embrace the unknown and learn something new.`
                        };

                        let finalMessage = messages[settings.motivationalStyle] || messages['Mentor'];
                        if (stats.energy.value < 30) {
                            finalMessage += " Your energy is low; remember that even operators need to recharge."
                        }
                        if (stats.currentStreak > 3) {
                            finalMessage += ` A ${stats.currentStreak}-day streak is impressive! Keep the momentum going.`
                        }

                        messageEl.textContent = finalMessage;
                    },
                    async addPoints(amount, category = 'Personal', isUndo = false) {
                        if (!app.state.userData) return;
                        const incrementVal = isUndo ? -1 : 1;
                        const charStatUpdates = {};
                        switch(category) {
                            case 'Work': case 'Finance': charStatUpdates['characterStats.discipline'] = increment(incrementVal); break;
                            case 'Learning': charStatUpdates['characterStats.focus'] = increment(incrementVal); break;
                            case 'Personal': charStatUpdates['characterStats.creativity'] = increment(incrementVal); break;
                            case 'Health': charStatUpdates['characterStats.wellness'] = increment(incrementVal); break;
                        }
                        
                        await app.firestore.updateUserData({
                            'stats.points': increment(amount),
                            ...charStatUpdates
                        });
                        this.checkLevelUp(); this.checkAchievement('hundred_points');
                    },
                    async checkLevelUp() {
                        if (!app.state.userData) return;
                        const stats = app.state.userData.stats;
                        let levelInfo = this.getLevelInfo(stats.level);
                        if (stats.points >= levelInfo.nextLevelXP) {
                            await app.firestore.updateUserData({ 'stats.level': increment(1) });
                            app.ui.showToast(`Chapter Complete! You are now on Chapter ${stats.level + 1}!`, 'success');
                            app.ui.triggerCelebration();
                            app.audio.playSound('levelUp');
                            this.checkAchievement('level_10');
                            this.checkAchievement('level_25');
                            this.checkAchievement('level_50');
                        }
                    },
                    getLevelInfo(level) {
                        const totalXPForLevel = (lvl) => Math.floor(50 * (Math.pow(1.6, lvl) - 1) / 0.6);
                        return { level, baseXP: totalXPForLevel(level - 1), nextLevelXP: totalXPForLevel(level) };
                    },
                    async updateStreak() {
                        if (!app.state.userData) return;
                        const stats = app.state.userData.stats;
                        const today = new Date().setHours(0,0,0,0);
                        const lastCompleted = stats.lastCompletedDate ? new Date(stats.lastCompletedDate).setHours(0,0,0,0) : null;
                        if (lastCompleted === today) return;

                        const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
                        let newStreak = stats.currentStreak;
                        let updates = {};

                        if (lastCompleted === yesterday.setHours(0,0,0,0)) { 
                            newStreak++; 
                        } else if (app.state.userData.inventory.streakProtection > 0) {
                            updates['inventory.streakProtection'] = increment(-1);
                            app.ui.showToast('Streak saved by a shield!', 'info');
                        } else {
                            if(stats.currentStreak > 0) app.ui.showToast('Streak lost! Complete a task to start a new one.', 'error');
                            newStreak = 0;
                        }
                        
                        updates['stats.currentStreak'] = newStreak;
                        if (newStreak > (stats.bestStreak || 0)) updates['stats.bestStreak'] = newStreak;
                        
                        await app.firestore.updateUserData(updates);
                        this.checkAchievement('week_streak');
                        this.checkAchievement('month_streak');
                        this.checkAchievement('year_streak');
                    },
                    async checkAchievement(id) {
                        if (!app.state.userData || app.state.userData.achievements.includes(id)) return;
                        const user = app.state.userData;
                        const conditions = {
                            first_goal: () => user.stats.totalGoals >= 1,
                            first_task: () => Object.values(app.state.localGoals).some(g => Object.values(g.tasks || {}).some(t => t.isCompleted)),
                            first_goal_completed: () => user.stats.completedGoals >= 1,
                            goal_master: () => user.stats.completedGoals >= 10,
                            week_streak: () => user.stats.currentStreak >= 7,
                            month_streak: () => user.stats.currentStreak >= 30,
                            year_streak: () => user.stats.currentStreak >= 365,
                            level_10: () => user.stats.level >= 10,
                            level_25: () => user.stats.level >= 25,
                            level_50: () => user.stats.level >= 50,
                            hundred_points: () => user.stats.points >= 100,
                            perfect_week: () => this.hasCompletedTasksForNDays(7),
                            template_sharer: () => Object.values(app.state.communityTemplates).some(t => t.authorId === user.uid),
                            community_pillar: () => Object.values(app.state.communityTemplates).filter(t => t.authorId === user.uid).length >= 5,
                            five_tasks_one_day: () => Object.values(user.stats.dailyCompletions).some(count => count >= 5),
                            first_journey_started: () => Object.keys(user.journeys).length > 0,
                            first_journey_completed: () => Object.values(user.journeys).some(j => j.status === 'completed'),
                            journeyman: () => Object.values(user.journeys).filter(j => j.status === 'completed').length >= 5,
                            challenge_participant: () => user.joinedChallenges.length > 0,
                            strategist: () => user.stats.usedTemplate,
                            first_friend: () => user.friends.length >= 1,
                            squad_leader: () => user.friends.length >= 5,
                            all_categories: () => {
                                const completedCategories = new Set(Object.values(app.state.localGoals).filter(g => g.completedAt).map(g => g.category));
                                const allCategories = new Set(Object.values(app.state.goalTemplates).map(t => t.category));
                                return allCategories.size > 0 && [...allCategories].every(cat => completedCategories.has(cat));
                            }
                        };
                        if (conditions[id] && conditions[id]()) {
                            const achievement = app.state.achievements[id];
                            await app.firestore.updateUserData({ achievements: arrayUnion(id) });
                            this.addPoints(achievement.points);
                            app.ui.showToast(`Achievement Unlocked: ${achievement.name}! (+${achievement.points} Essence)`, 'success');
                            app.audio.playSound('achievement');
                            if (app.state.activeView === 'achievements') {
                                const badge = document.querySelector(`.achievement-badge[data-id="${id}"]`);
                                if (badge) badge.classList.add('celebrate');
                            }
                        }
                    },
                    hasCompletedTasksForNDays(n) {
                        const completions = app.state.userData.stats.dailyCompletions;
                        for (let i = 0; i < n; i++) {
                            const d = new Date(); d.setDate(d.getDate() - i);
                            const dayStr = d.toISOString().split('T')[0];
                            if (!completions[dayStr] || completions[dayStr] === 0) return false;
                        }
                        return true;
                    },
                    getWeeklyActivity() {
                        const data = [];
                        const completions = app.state.userData.stats.dailyCompletions;
                        for (let i = 6; i >= 0; i--) {
                            const d = new Date(); d.setDate(d.getDate() - i);
                            const dayStr = d.toISOString().split('T')[0];
                            const label = d.toLocaleDateString('en-US', { weekday: 'short' });
                            data.push({ label, value: completions[dayStr] || 0 });
                        }
                        return data;
                    },
                    async logDailyCompletion() {
                        const todayStr = new Date().toISOString().split('T')[0];
                        const stats = app.state.userData.stats;
                        const newCount = (stats.dailyCompletions[todayStr] || 0) + 1;
                        let updates = {
                            [`stats.dailyCompletions.${todayStr}`]: newCount,
                            'stats.lastCompletedDate': new Date().toISOString()
                        };
                        if (newCount > (stats.bestDay.count || 0)) {
                            updates['stats.bestDay'] = { date: todayStr, count: newCount };
                        }
                        if (stats.currentStreak === 0) {
                            updates['stats.currentStreak'] = 1;
                        }
                        await app.firestore.updateUserData(updates);
                        this.checkAchievement('perfect_week');
                        this.checkAchievement('five_tasks_one_day');
                    },
                    async checkTreasureChest() {
                        await app.firestore.updateUserData({ 'stats.tasksUntilChest': increment(-1) });
                        if (app.state.userData.stats.tasksUntilChest - 1 <= 0) {
                           app.ui.showToast('Treasure Chest is ready to open!', 'info');
                        }
                    },
                    openTreasureChest() {
                        const modal = document.getElementById('treasure-chest-modal');
                        const rewardEl = document.getElementById('opened-chest-reward');
                        const closedChest = document.getElementById('closed-chest-icon');
                        
                        rewardEl.classList.add('hidden');
                        closedChest.classList.remove('hidden');
                        modal.classList.add('active');
                    },
                    claimTreasureChestReward() {
                        const rewards = [
                            { label: "+50 Essence", action: () => app.gamification.addPoints(50) },
                            { label: "Streak Shield", action: () => app.firestore.updateUserData({ 'inventory.streakProtection': increment(1) }).then(() => app.ui.showToast('Streak Shield acquired!', 'success')) },
                            { label: "+100 Essence", action: () => app.gamification.addPoints(100) },
                        ];
                        const reward = rewards[Math.floor(Math.random() * rewards.length)];
                        
                        const rewardEl = document.getElementById('opened-chest-reward');
                        const closedChest = document.getElementById('closed-chest-icon');
                        
                        rewardEl.innerHTML = `<div class="chest-reward"><strong>${reward.label}</strong></div>`;
                        closedChest.classList.add('hidden');
                        rewardEl.classList.remove('hidden');

                        app.ui.triggerCelebration();
                        reward.action();
                        app.firestore.updateUserData({ 'stats.tasksUntilChest': Math.floor(Math.random() * 6) + 5 });
                    },
                    async joinCommunityChallenge(challengeId) {
                        if (!app.state.userData.joinedChallenges.includes(challengeId)) {
                            await app.firestore.updateUserData({ joinedChallenges: arrayUnion(challengeId) });
                            app.gamification.checkAchievement('challenge_participant');
                            app.ui.showToast("Challenge joined!", "success");
                        }
                    },
                    async updateCommunityChallengeProgress(category) {
                        const user = app.state.userData;
                        for (const challengeDef of app.state.communityChallenges) {
                            if (challengeDef.category === category && user.joinedChallenges.includes(challengeDef.id)) {
                                const challengeRef = doc(db, "globalChallenges", challengeDef.id);
                                const challengeData = app.state.globalChallenges[challengeDef.id];
                                if (!challengeData.completed) {
                                    await updateDoc(challengeRef, { progress: increment(1) });
                                    if (challengeData.progress + 1 >= challengeDef.goal) {
                                        await updateDoc(challengeRef, { completed: true });
                                        app.ui.showToast(`Community Challenge "${challengeDef.name}" Complete!`, 'success');
                                    }
                                }
                            }
                        }
                    }
                },
                
                // --- AUDIO SYSTEM ---
                audio: {
                    synths: {},
                    soundQueue: [],
                    isPlaying: false,
                    init() {
                        try {
                            this.synths.taskComplete = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }, volume: -20 }).toDestination();
                            this.synths.levelUp = new Tone.FMSynth({ harmonicity: 2, modulationIndex: 3, detune: 0, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.1, decay: 0.1, sustain: 0.3, release: 0.5 }, volume: -18 }).toDestination();
                            this.synths.achievement = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 }, volume: -22 }).toDestination();
                        } catch (e) {
                            console.warn("Tone.js failed to initialize. Audio will be disabled.", e);
                            this.synths = {};
                        }
                    },
                    playSound(sound) {
                        this.soundQueue.push(sound);
                        if (!this.isPlaying) {
                            this.playNextSound();
                        }
                    },
                    playNextSound() {
                        if (this.soundQueue.length === 0) {
                            this.isPlaying = false;
                            return;
                        }
                        this.isPlaying = true;
                        const sound = this.soundQueue.shift();

                        if (!this.synths[sound] || !Tone.context.state || Tone.context.state !== 'running') {
                            setTimeout(() => this.playNextSound(), 100);
                            return;
                        };

                        const now = Tone.now();
                        let duration = 0;

                        if (sound === 'taskComplete') {
                            this.synths.taskComplete.triggerAttackRelease("C5", "8n", now);
                            this.synths.taskComplete.triggerAttackRelease("G5", "8n", now + 0.1);
                            duration = 0.2;
                        } else if (sound === 'levelUp') {
                            this.synths.levelUp.triggerAttackRelease("C4", "4n", now);
                            this.synths.levelUp.triggerAttackRelease("G4", "4n", now + 0.2);
                            this.synths.levelUp.triggerAttackRelease("C5", "4n", now + 0.4);
                            duration = 0.6;
                        } else if (sound === 'achievement') {
                            this.synths.achievement.triggerAttackRelease(["C5", "E5", "G5"], "8n", now);
                            duration = 0.3;
                        }
                        
                        setTimeout(() => this.playNextSound(), duration * 1000);
                    }
                },

                // --- AI PROVIDER LOGIC (NOW WITH NETLIFY PROXY) ---
                ai: {
                    async call(messages) {
                        if (!app.state.userData) throw new Error("User not loaded.");
                        const provider = app.state.userData.settings.aiProvider;
                        if (!provider || provider === 'none') {
                            throw new Error("No AI provider selected in settings.");
                        }
                        
                        const response = await fetch('/.netlify/functions/ai-proxy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ provider, messages })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'AI proxy request failed.');
                        }
                        
                        return data.response;
                    }
                },

                // --- EVENT LISTENERS ---
                eventListeners: {
                    init() {
                        document.body.addEventListener('click', async () => { if (Tone.context.state !== 'running') await Tone.start(); }, { once: true });

                        // Auth
                        document.getElementById('login-form-element').addEventListener('submit', e => { e.preventDefault(); app.auth.login(document.getElementById('login-email').value, document.getElementById('login-password').value); });
                        document.getElementById('register-form-element').addEventListener('submit', e => { e.preventDefault(); app.auth.register(document.getElementById('register-name').value, document.getElementById('register-email').value, document.getElementById('register-password').value); });
                        document.getElementById('show-register').addEventListener('click', () => { document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); });
                        document.getElementById('show-login').addEventListener('click', () => { document.getElementById('register-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });
                        document.getElementById('logout-btn').addEventListener('click', () => app.auth.logout());
                        
                        // Main Actions
                        document.getElementById('add-goal-btn').addEventListener('click', () => app.ui.openGoalModal());
                        document.getElementById('add-goal-template-btn').addEventListener('click', () => {
                            const modal = document.getElementById('template-modal');
                            const systemList = document.getElementById('template-list-system');
                            const communityList = document.getElementById('template-list-community');
                            systemList.innerHTML = '';
                            communityList.innerHTML = '';

                            app.state.goalTemplates.forEach((template) => {
                                const btn = this.createTemplateButton(template, false);
                                systemList.appendChild(btn);
                            });

                            const communityTemplates = Object.values(app.state.communityTemplates || {});
                            if (communityTemplates.length > 0) {
                                communityTemplates.forEach(template => {
                                    const btn = this.createTemplateButton(template, true);
                                    communityList.appendChild(btn);
                                });
                            } else {
                                communityList.innerHTML = `<p style="color: var(--text-muted-color); text-align: center; padding: 1rem;">No community templates yet. Be the first to share one!</p>`;
                            }
                            
                            modal.classList.add('active');
                        });
                        document.getElementById('show-active-goals-btn').addEventListener('click', () => { app.state.showingArchived = false; app.ui.renderGoals(); });
                        document.getElementById('show-archived-goals-btn').addEventListener('click', () => { app.state.showingArchived = true; app.ui.renderGoals(); });
                        document.getElementById('share-progress-btn').addEventListener('click', () => {
                            if (!app.state.userData) return;
                            const { displayName, stats } = app.state.userData;
                            const summary = `Operator Uplift Status Report: ${displayName}\n\n‚≠ê Chapter: ${stats.level}\nüí∞ Essence: ${stats.points}\n‚ö° Energy: ${Math.floor(stats.energy.value)}/100\nüî• Streak: ${stats.currentStreak} days\n\nJoin the operation!`;
                            const textArea = document.createElement("textarea");
                            textArea.value = summary; textArea.style.position = "fixed"; document.body.appendChild(textArea);
                            textArea.focus(); textArea.select();
                            try { document.execCommand('copy'); app.ui.showToast('Progress summary copied!', 'success'); } 
                            catch (err) { app.ui.showToast('Failed to copy text.', 'error'); }
                            document.body.removeChild(textArea);
                        });
                         document.getElementById('share-x-btn').addEventListener('click', () => {
                            if (!app.state.userData) return;
                            const { displayName, stats } = app.state.userData;
                            const summary = `My Operator Uplift Status:\n\n‚≠ê Chapter: ${stats.level}\nüí∞ Essence: ${stats.points}\nüî• Streak: ${stats.currentStreak} days\n\nDeconstruct your ambition. Engineer your ascent. #OperatorUplift`;
                            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(summary)}`, '_blank');
                        });

                        // Modals
                        document.querySelectorAll('.modal-close').forEach(btn => {
                            btn.addEventListener('click', () => btn.closest('.modal').classList.remove('active'));
                        });
                        document.getElementById('goal-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const submitBtn = document.getElementById('goal-form-submit-btn');
                            submitBtn.disabled = true; submitBtn.textContent = 'Saving...';
                            const goalData = {
                                id: document.getElementById('goal-id-input').value, parentId: document.getElementById('goal-parent-id-input').value || null,
                                title: document.getElementById('goal-title').value, description: document.getElementById('goal-description').value,
                                category: document.getElementById('goal-category').value, priority: document.getElementById('goal-priority').value, dueDate: document.getElementById('goal-due-date').value,
                            };
                            if (e.target.dataset.templateTasks) { 
                                goalData.tasks = JSON.parse(e.target.dataset.templateTasks); 
                                app.firestore.updateUserData({ 'stats.usedTemplate': true });
                                app.gamification.checkAchievement('strategist');
                                delete e.target.dataset.templateTasks; 
                            }
                            await app.goals.save(goalData);
                            submitBtn.disabled = false; submitBtn.textContent = 'Embark on Quest';
                        });
                        document.getElementById('template-tabs').addEventListener('click', e => {
                            if (e.target.classList.contains('template-tab')) {
                                const tab = e.target.dataset.tab;
                                document.querySelectorAll('.template-tab').forEach(t => t.classList.remove('active'));
                                e.target.classList.add('active');
                                document.getElementById('template-list-system').classList.toggle('hidden', tab !== 'system');
                                document.getElementById('template-list-community').classList.toggle('hidden', tab !== 'community');
                            }
                        });
                        document.getElementById('spin-wheel-btn').addEventListener('click', () => app.ui.spinWheel());
                        document.getElementById('chest-icon').addEventListener('click', () => { if(app.state.userData?.stats.tasksUntilChest <= 0) app.gamification.openTreasureChest(); });
                        document.getElementById('closed-chest-icon').addEventListener('click', () => app.gamification.claimTreasureChestReward());
                        document.getElementById('mood-selector').addEventListener('click', (e) => {
                            const mood = e.target.dataset.mood;
                            if (mood) {
                                const today = new Date().toISOString().split('T')[0];
                                app.firestore.updateUserData({ [`moods.${today}`]: mood });
                                document.getElementById('mood-modal').classList.remove('active');
                                document.getElementById('lucky-wheel-modal').classList.add('active');
                            }
                        });

                        // Journey Modal
                        document.getElementById('journey-grid').addEventListener('click', e => {
                            if (e.target.classList.contains('start-journey-btn')) {
                                const journeyId = e.target.closest('.journey-card').dataset.journeyId;
                                const template = app.state.journeyTemplates[journeyId];
                                const modal = document.getElementById('journey-modal');
                                document.getElementById('journey-modal-title').textContent = template.name;
                                document.getElementById('journey-modal-description').textContent = template.description;
                                document.getElementById('journey-confirm-start-btn').dataset.journeyId = journeyId;
                                modal.classList.add('active');
                            }
                        });
                        document.getElementById('journey-confirm-start-btn').addEventListener('click', e => {
                            app.journeys.start(e.target.dataset.journeyId);
                        });

                        // Calendar Listeners
                        document.getElementById('prev-month-btn').addEventListener('click', () => {
                            app.state.calendarDate.setMonth(app.state.calendarDate.getMonth() - 1);
                            app.ui.renderCalendar();
                        });
                        document.getElementById('next-month-btn').addEventListener('click', () => {
                            app.state.calendarDate.setMonth(app.state.calendarDate.getMonth() + 1);
                            app.ui.renderCalendar();
                        });
                        document.getElementById('calendar-days').addEventListener('click', e => {
                            const dayCell = e.target.closest('.calendar-day');
                            if (dayCell && !e.target.closest('.calendar-task')) {
                                app.ui.showCalendarAddTaskModal(dayCell.dataset.date);
                            }
                        });
                        document.getElementById('calendar-add-task-form').addEventListener('submit', e => {
                            e.preventDefault();
                            const goalId = document.getElementById('calendar-task-goal-select').value;
                            const description = document.getElementById('calendar-task-description-input').value;
                            const dueDate = document.getElementById('calendar-task-due-date').value;
                            app.goals.addTask(goalId, description, dueDate);
                            e.target.reset();
                            document.getElementById('calendar-add-task-modal').classList.remove('active');
                        });
                        
                        // Calendar Drag and Drop
                        let draggedTask = null;
                        document.getElementById('calendar-days').addEventListener('dragstart', e => {
                            if (e.target.classList.contains('calendar-task')) {
                                draggedTask = e.target;
                                e.dataTransfer.setData('text/plain', JSON.stringify({
                                    taskId: e.target.dataset.taskId,
                                    goalId: e.target.dataset.goalId
                                }));
                                setTimeout(() => e.target.classList.add('dragging'), 0);
                            }
                        });
                        document.getElementById('calendar-days').addEventListener('dragend', e => {
                            if (draggedTask) {
                                draggedTask.classList.remove('dragging');
                                draggedTask = null;
                            }
                        });
                        document.getElementById('calendar-days').addEventListener('dragover', e => {
                            e.preventDefault();
                            const dayCell = e.target.closest('.calendar-day');
                            if (dayCell) {
                                document.querySelectorAll('.calendar-day.drag-over').forEach(el => el.classList.remove('drag-over'));
                                dayCell.classList.add('drag-over');
                            }
                        });
                        document.getElementById('calendar-days').addEventListener('dragleave', e => {
                             const dayCell = e.target.closest('.calendar-day');
                             if (dayCell) dayCell.classList.remove('drag-over');
                        });
                        document.getElementById('calendar-days').addEventListener('drop', e => {
                            e.preventDefault();
                            document.querySelectorAll('.calendar-day.drag-over').forEach(el => el.classList.remove('drag-over'));
                            const dayCell = e.target.closest('.calendar-day');
                            if (dayCell && dayCell.dataset.date) {
                                const { taskId, goalId } = JSON.parse(e.dataTransfer.getData('text/plain'));
                                const newDueDate = dayCell.dataset.date;
                                app.goals.updateTaskDueDate(goalId, taskId, newDueDate);
                            }
                        });


                        // Community Listeners
                        document.getElementById('challenge-list').addEventListener('click', e => {
                            if (e.target.classList.contains('join-challenge-btn')) {
                                app.gamification.joinCommunityChallenge(e.target.dataset.challengeId);
                            }
                        });
                        document.getElementById('add-friend-form').addEventListener('submit', e => {
                            e.preventDefault();
                            const uid = document.getElementById('add-friend-uid').value;
                            app.friends.add(uid);
                            e.target.reset();
                        });
                        document.getElementById('copy-uid-btn').addEventListener('click', () => {
                            if (!app.state.currentUser) return;
                            const uid = app.state.currentUser.uid;
                            const textArea = document.createElement("textarea");
                            textArea.value = uid; textArea.style.position = "fixed"; document.body.appendChild(textArea);
                            textArea.focus(); textArea.select();
                            try { document.execCommand('copy'); app.ui.showToast('User ID copied!', 'success'); } 
                            catch (err) { app.ui.showToast('Failed to copy.', 'error'); }
                            document.body.removeChild(textArea);
                        });

                        // Settings
                        document.getElementById('delete-account-btn').addEventListener('click', () => app.auth.deleteAccount());
                        document.getElementById('color-scheme-grid').addEventListener('click', e => {
                            const swatch = e.target.closest('.color-swatch');
                            if (swatch) {
                                const schemeName = swatch.dataset.scheme;
                                app.firestore.updateUserData({ 'settings.colorScheme': schemeName });
                            }
                        });
                        document.getElementById('motivational-style-select').addEventListener('change', e => {
                            if (app.state.userData) {
                                app.firestore.updateUserData({ 'settings.motivationalStyle': e.target.value });
                                app.gamification.getAIMentorMessage();
                            }
                        });
                        document.getElementById('ai-provider-select').addEventListener('change', e => {
                            if (app.state.userData) {
                                app.firestore.updateUserData({ 'settings.aiProvider': e.target.value });
                            }
                        });
                        
                        // Goal, Task, and Journey List Delegation
                        document.getElementById('goal-list').addEventListener('click', e => {
                            const goalItem = e.target.closest('.goal-item'); if (!goalItem) return;
                            const goalId = goalItem.dataset.id;
                            const taskItem = e.target.closest('.task-item');
                            
                            if (taskItem) {
                                const taskId = taskItem.dataset.id;
                                if (e.target.classList.contains('task-checkbox')) { app.goals.toggleTask(goalId, taskId, taskItem); } 
                                else if (e.target.classList.contains('subtask-checkbox')) { app.goals.toggleSubTask(goalId, taskId, e.target.dataset.index); }
                                else if (e.target.classList.contains('task-description')) { this.enableTaskEditing(e.target); }
                                else if (e.target.classList.contains('ai-breakdown-btn')) { app.goals.aiBreakdownTask(goalId, taskId); }
                                return;
                            }
                            if (e.target.classList.contains('goal-edit-btn')) { app.ui.openGoalModal(app.state.localGoals[goalId]); }
                            else if (e.target.classList.contains('goal-delete-btn')) { app.goals.delete(goalId, app.state.localGoals[goalId].isArchived); }
                            else if (e.target.classList.contains('goal-unarchive-btn')) { app.goals.unarchive(goalId); }
                            else if (e.target.classList.contains('add-subgoal-btn')) { app.ui.openGoalModal(null, goalId); }
                            else if (e.target.classList.contains('add-task-btn')) { app.ui.showAddTaskModal(goalId); }
                            else if (e.target.classList.contains('share-template-btn')) { app.goals.shareGoalAsTemplate(goalId); }
                            else if (e.target.classList.contains('complete-all-tasks-btn')) { app.goals.completeAllTasks(goalId); }
                        });
                        
                        let draggedItem = null;
                        document.getElementById('goal-list').addEventListener('dragstart', e => { if (e.target.classList.contains('task-item')) { draggedItem = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); } });
                        document.getElementById('goal-list').addEventListener('dragend', () => { if (draggedItem) { draggedItem.classList.remove('dragging'); const goalId = draggedItem.closest('.goal-item').dataset.id; const taskList = draggedItem.parentElement; const orderedTaskIds = [...taskList.querySelectorAll('.task-item')].map(item => item.dataset.id); app.goals.updateTaskOrder(goalId, orderedTaskIds); draggedItem = null; } });
                        document.getElementById('goal-list').addEventListener('dragover', e => { e.preventDefault(); const taskList = e.target.closest('.task-list'); if (taskList && draggedItem) { const afterElement = this.getDragAfterElement(taskList, e.clientY); if (afterElement == null) { taskList.appendChild(draggedItem); } else { taskList.insertBefore(draggedItem, afterElement); } } });

                        // Onboarding Listeners
                        document.getElementById('tutorial-close-btn').addEventListener('click', () => document.getElementById('tutorial-modal').classList.remove('active'));
                        document.getElementById('profile-analysis-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            await app.ui.analyzeProfile(formData);
                            e.target.classList.add('hidden');
                        });
                        document.getElementById('add-task-form').addEventListener('submit', e => {
                            e.preventDefault();
                            const goalId = document.getElementById('add-task-goal-id').value;
                            const description = document.getElementById('add-task-description-input').value;
                            const dueDate = document.getElementById('add-task-due-date-input').value;
                            app.goals.addTask(goalId, description, dueDate);
                            e.target.reset();
                            document.getElementById('add-task-modal').classList.remove('active');
                        });
                    },
                    createTemplateButton(template, isCommunity) {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-outline';
                        btn.style.width = '100%';
                        btn.style.marginBottom = '0.5rem';
                        btn.style.textAlign = 'left';
                        
                        let buttonHTML = `<span>${template.title}</span>`;
                        if (isCommunity) {
                            buttonHTML += `<span style="font-size: 0.8rem; color: var(--text-muted-color); margin-left: auto;">by ${template.author}</span>`;
                            btn.style.display = 'flex';
                            btn.style.justifyContent = 'space-between';
                            btn.style.alignItems = 'center';
                        }
                        btn.innerHTML = buttonHTML;

                        btn.onclick = () => {
                            app.ui.openGoalModal();
                            document.getElementById('goal-title').value = template.title;
                            document.getElementById('goal-description').value = template.description;
                            document.getElementById('goal-category').value = template.category;
                            const tasks = {};
                            template.tasks.forEach((task, i) => {
                                const taskId = `task_${new Date().getTime()}_${i}`;
                                const description = typeof task === 'string' ? task : task.description;
                                tasks[taskId] = { id: taskId, description: description, isCompleted: false, order: i, subTasks: [] };
                            });
                            document.getElementById('goal-form').dataset.templateTasks = JSON.stringify(tasks);
                            document.getElementById('template-modal').classList.remove('active');
                        };
                        return btn;
                    },
                    enableTaskEditing(taskDescriptionSpan) {
                        const taskItem = taskDescriptionSpan.closest('.task-item'); const goalId = taskItem.closest('.goal-item').dataset.id; const taskId = taskItem.dataset.id;
                        const input = document.createElement('input');
                        input.type = 'text'; input.value = taskDescriptionSpan.textContent; input.className = 'task-edit-input';
                        taskDescriptionSpan.replaceWith(input); input.focus(); input.select();
                        const saveEdit = () => {
                            const newDescription = input.value.trim();
                            if (newDescription && newDescription !== taskDescriptionSpan.textContent) { app.goals.updateTaskDescription(goalId, taskId, newDescription); taskDescriptionSpan.textContent = newDescription; }
                            input.replaceWith(taskDescriptionSpan);
                        };
                        input.addEventListener('blur', saveEdit);
                        input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') input.blur(); else if (ev.key === 'Escape') { input.replaceWith(taskDescriptionSpan); } });
                    },
                    getDragAfterElement(container, y) {
                        const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
                        return draggableElements.reduce((closest, child) => {
                            const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2;
                            if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; }
                        }, { offset: Number.NEGATIVE_INFINITY }).element;
                    }
                }
            };

            // Kick off the application
            app.init();
        });
    </script>
</body>
</html>
